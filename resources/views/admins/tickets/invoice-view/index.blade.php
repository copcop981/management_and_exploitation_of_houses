@extends('admins.layouts.master')

@section('title')
    Quản lý bán vé - Trung tâm quản lý và khai thác nhà Đà Nẵng
@endsection

@section('style')
<style>
    table {
        min-width: max-content;
    }


    th {
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
        background: #333;
        position: sticky;
        top: 0;
        z-index: 999;
    }

    .table-wrapper {
        max-height: 450px;
        overflow: scroll;
    }

    .table-wrapper button[type='button']:disabled {
        cursor: not-allowed;
    }
</style>
@endsection

@section('content')
<!--# Page header -->
<div class="page-header page-header-light">
    <div class="page-header-content header-elements-lg-inline">
        <div class="page-title d-flex"></div>
        <div class="header-elements d-none">
            <div class="d-flex justify-content-center">
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
            </div>
        </div>
    </div>
    <div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
        <div class="d-flex">
            <div class="breadcrumb">
                <a href="" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
                <a href="" class="breadcrumb-item">Vé xe</a>
                <span href="" class="breadcrumb-item active">Xem hóa đơn</span>
            </div>
            <a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
        </div>

    </div>
</div>
<!--# /page header -->

<div class="content">
    <div class="card mb-4">
        <div class="container mb-2">
            <div class="mt-2" style="box-shadow: 0 4px 2px -2px #ddd;">
                <div class="p-1 pl-2 bg-primary text-light" style="border-radius: 5px 5px 0 0;">
                    Danh sách hóa đơn
                </div>
                <form action="" class="mt-2 pr-5" id="form_search">
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <div class="col-3">
                                        <label for="" class="float-right col-form-label">Loại vé</label>
                                    </div>
                                    <div class="col-9">
                                        <select name="" id="ticket_type" class="form-control form-control-sm custom-select">
                                            <option value="">-- Chọn loại vé --</option>
                                            @foreach ($types as $type)
                                                <option value="{{ $type->id }}">{{ $type->ticket_name }}</option>
                                            @endforeach
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <label for="" class="float-right col-form-label">Trạng thái hóa đơn</label>
                                    </div>
                                    <div class="col-8">
                                        <select name="" id="invoice_status" class="form-control form-control-sm custom-select">
                                            <option value="">-- Chọn trạng thái --</option>
                                                @foreach ($statuses as $status)
                                                    <option value="{{ $status->id }}">{{ $status->status }}</option>
                                                @endforeach
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <div class="col-3">
                                        <label for="" class="float-right col-form-label">Từ ngày</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="date" class="form-control form-control-sm" id="from_date">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <div class="col-4">
                                        <label for="" class="float-right col-form-label">Đến ngày</label>
                                    </div>
                                    <div class="col-8">
                                        <input type="date" class="form-control form-control-sm" id="to_date">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-6">
                        </div>
                        <div class="col-6">
                            <div class="form-group">
                                <div class="row align-items-center">
                                    <div class="col-4">
                                    </div>
                                    <div class="col-8">
                                        <button type="button" class="btn btn-success btn-sm" id="btn_search">
                                            <i class="fa-solid fa-magnifying-glass mr-1"></i>
                                            Tìm kiếm
                                        </button>
                                        <button type="button" class="btn btn-warning btn-sm" id="btn_refresh_input_search">
                                            <i class="fa-solid fa-rotate mr-1"></i>
                                            Làm mới
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="mt-2">
                <div class="mt-1 d-flex justify-content-between">
                    <div>
                        <select name="" class="form-control form-control-sm custom-select" id="row">
                            <option value="5">5 hàng</option>
                            <option value="10">10 hàng</option>
                            <option value="15">15 hàng</option>
                            <option value="20">20 hàng</option>
                        </select>
                    </div>
            
                    {{-- <div class="d-flex align-items-center">
                        <span style="width: 110px;">Tìm kiếm:</span>
                        <input type="text" name="" id="" class="form-control form-control-sm">
                    </div> --}}
                </div>
                <div id="list_ticket_table">
                    @include('admins.tickets.invoice-view.pagination')
                </div>
            </div>

            {{-- Modal Lập Hóa đơn Thay thế --}}
            <div class="modal fade" id="modal_replace" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Nhập thông tin Hóa đơn cần Thay thế</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="" id="form_replace">
                                <div class="row">
                                    <div class="col-4">
                                        <label for="" class="col-form-label-sm float-right">Họ tên người mua hàng:</label>
                                    </div>
                                    <div class="col-8">
                                        <input type="text" class="form-control form-control-sm" id="cus_name_replace">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <label for="" class="col-form-label-sm float-right">Tên sản phẩm:</label>
                                    </div>
                                    <div class="col-8">
                                        <input type="text" class="form-control form-control-sm" id="product_name_replace">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <label for="" class="col-form-label-sm float-right">Đơn giá:</label>
                                    </div>
                                    <div class="col-8">
                                        <input type="number" class="form-control form-control-sm" id="price_replace">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary btn-sm" id="btn_confirm_replace" style="margin-left: 0.5rem !important;">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Modal Lập Hóa đơn Điều chỉnh --}}
            <div class="modal fade" id="modal_adjust" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Nhập thông tin Hóa đơn cần Điều chỉnh</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="" id="form_adjust">
                                <div class="row">
                                    <div class="col-3">
                                        <label for="adjust_type_cbb" class="col-form-label-sm float-right">Kiểu điều chỉnh:</label>
                                    </div>
                                    <div class="col-9">
                                        <select name="" id="adjust_type_cbb" class="form-control custom-select custom-select-sm">
                                            <option value="">-- Chọn kiểu điều chỉnh --</option>
                                            <option value="2">Hóa đơn điều chỉnh tăng</option>
                                            <option value="3">Hóa đơn điều chỉnh giảm</option>
                                            <option value="4">Hóa đơn điều chỉnh thông tin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-4">
                                        <label for="adjust_price_input" class="col-form-label-sm float-right d-none" id="adjust_price_label"></label>
                                    </div>
                                    <div class="col-8">
                                        <input type="number" class="form-control form-control-sm d-none" id="adjust_price_input">
                                    </div>
                                </div>

                                <div class="d-none" id="adjust_infor">
                                    <div class="row">
                                        <div class="col-4">
                                            <label for="adjust_cus_name" class="col-form-label-sm float-right">Họ tên người mua hàng:</label>
                                        </div>
                                        <div class="col-8">
                                            <input type="text" class="form-control form-control-sm" id="adjust_cus_name">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-4">
                                            <label for="adjust_product_name" class="col-form-label-sm float-right">Tên sản phẩm:</label>
                                        </div>
                                        <div class="col-8">
                                            <input type="text" class="form-control form-control-sm" id="adjust_product_name">
                                        </div>
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-success btn-sm" id="btn_confirm_adjust" style="margin-left: 0.5rem !important;">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Modal Xác nhận Hủy Hóa đơn --}}
            <div class="modal fade" id="modal_cancel" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Xác nhận</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <span>Xác nhận Hủy Hóa đơn?</span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-danger btn-sm" id="btn_confirm_cancel" style="margin-left: 0.5rem !important;">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('script')
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        function today() {
            let now = new Date();
            let date = ('0' + now.getDate()).slice(-2);
            let month = ('0' + (now.getMonth() + 1)).slice(-2);
            let year = now.getFullYear();
            let today = year + '-' + month + '-' + date;
            return today;
        }
        
        let invoiceStatusId = $('#invoice_status');
        let fromDate = $('#from_date');
        let toDate = $('#to_date');

        $(document).on('click', '.pagination a', function(e) {
            e.preventDefault();
            let page = $(this).attr('href').split('?page=')[1];
            let numRow = $('#row').val();
            $.ajax({
                url: "/admins/ticket/invoice-view/fetch?page=" + page,
                data: {
                    numRow: numRow > 0 ? numRow : 0,
                    ticketType: $('#ticket_type > option:selected').not('option:first-child').text(),
                    invoiceStatusId: invoiceStatusId.val(),
                    fromDate: fromDate.val(),
                    toDate: toDate.val(),
                },
                success: function (res) {
                    $('#list_ticket_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });

        $(document).on('change', '#row', function() {
            let numRow = $(this).val();
            $.ajax({
                url: "{{ route('get.row.ticket.invoice') }}",
                data: {
                    numRow: numRow,
                    ticketType: $('#ticket_type > option:selected').not('option:first-child').text(),
                    invoiceStatusId: invoiceStatusId.val(),
                    fromDate: fromDate.val(),
                    toDate: toDate.val(),
                },
                success: function (res) {
                    $('#list_ticket_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });

        $(document).off('click', '#btn_refresh_input_search').on('click', '#btn_refresh_input_search', function(e) {
            e.preventDefault();
            $('#form_search').find(':input').val('');
            $('#row').val('5').change();
            // getNow();
        });

        $(document).prop('disabled', false).off('click', '#btn_search').on('click', '#btn_search', function(e) {
            e.preventDefault();
            $(this).prop('disabled', true);
            if(new Date(fromDate.val()) > new Date(toDate.val()) || 
                new Date(fromDate.val()) > new Date(today()) || 
                new Date(toDate.val()) > new Date(today())) {
                    alert('Chọn ngày không hợp lệ');
                    $(this).prop('disabled', false);
                    return;
            }
            $.ajax({
                type: "GET",
                url: "{{ route('ticket.invoice.search') }}",
                data: {
                    ticketType: $('#ticket_type > option:selected').not('option:first-child').text(),
                    invoiceStatusId: invoiceStatusId.val(),
                    fromDate: fromDate.val(),
                    toDate: toDate.val(),
                },
                success: function (res) {
                    $('#list_ticket_table').html(res);
                    $('#row').val('15');
                    $('#btn_search').prop('disabled', false);
                }
            });
        });

        $(document).off('click', '#btn_replace').on('click', '#btn_replace', function(e) {
            e.preventDefault();
            let id = $(this).val();
            $('#modal_replace').modal('show');

            $(document).prop('disabled', false).off('click', '#btn_confirm_replace').on('click', '#btn_confirm_replace', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                let cusName = $('#cus_name_replace');
                let productName = $('#product_name_replace');
                let price = $('#price_replace');
                let url = "{{ route('confirm.replace.bill', ':id') }}";
                url = url.replace(':id', id);
                $.ajax({
                    type: "POST",
                    url: url,
                    data: { 
                        cusName: cusName.val(),
                        productName: productName.val(),
                        price: price.val(),
                        _token: "{{ csrf_token() }}", 
                    },
                    success: function (res) {
                        alert(res.message.replaceInvResult);
                        $('#btn_confirm_replace').prop('disabled', false);
                        $('#modal_replace').modal('hide');
                        $('#btn_refresh_input_search').click();
                    }
                });
            });

            $(document).off('hidden.bs.modal', '#modal_replace').on('hidden.bs.modal', '#modal_replace', function() {
                $('#form_replace').find(':input').val('');
            });
        });

        $(document).off('click', '#btn_adjust').on('click', '#btn_adjust', function(e) {
            e.preventDefault();
            let id = $(this).val();
            let adjustPriceLabel = $('#adjust_price_label');
            let adjustPriceInput = $('#adjust_price_input');
            let adjustInfor = $('#adjust_infor');
            let adjustCusName = $('#adjust_cus_name');
            let adjustProductName = $('#adjust_product_name');
            $('#modal_adjust').modal('show');

            $(document).off('change', '#adjust_type_cbb').on('change', '#adjust_type_cbb', function() {
                let adjustType = $(this).val();
                if(adjustType == '2') {
                    adjustInfor.addClass('d-none');
                    adjustPriceLabel.removeClass('d-none').text('Nhập tổng tiền sau khi tăng: ');
                    adjustPriceInput.removeClass('d-none').val('');
                } else if(adjustType == '3') {
                    adjustInfor.addClass('d-none');
                    adjustPriceLabel.removeClass('d-none').text('Nhập số tiền cần giảm: ');
                    adjustPriceInput.removeClass('d-none').val('');
                }
                 else if(adjustType == '4') {
                    adjustInfor.removeClass('d-none');
                    $('#adjust_price_label, #adjust_price_input').addClass('d-none');
                } else $('#adjust_price_label, #adjust_price_input, #adjust_infor').addClass('d-none');
            });

            $(document).prop('disabled', false).off('click', '#btn_confirm_adjust').on('click', '#btn_confirm_adjust', function(e) {
                e.preventDefault();
                let adjustType = $('#adjust_type_cbb');
                let url = "{{ route('confirm.adjust.bill', ':id') }}";
                url = url.replace(':id', id);
                $(this).prop('disabled', true);
                $.ajax({
                    type: "POST",
                    url: url,
                    data: { 
                        adjustType: adjustType.val(),
                        adjustPrice: adjustPriceInput.val(),
                        adjustCusName: adjustCusName.val(),
                        adjustProductName: adjustProductName.val(),
                        _token: "{{ csrf_token() }}", 
                    },
                    success: function (res) {
                        alert(res.message.adjustInvResult);
                        $('#btn_confirm_adjust').prop('disabled', false);
                        $('#modal_adjust').modal('hide');
                        $('#btn_refresh_input_search').click();
                    }
                });
            });

            $(document).off('hidden.modal.bs', '#modal_adjust').on('hidden.modal.bs', '#modal_adjust', function() {
                $('#adjust_type_cbb').val('');
                $('#adjust_label, #adjust_input').addClass('d-none');
            });
        });

        $(document).off('click', '#btn_cancel').on('click', '#btn_cancel', function(e) {
            e.preventDefault();
            let id = $(this).val();
            $('#modal_cancel').modal('show');

            $(document).prop('disabled', false).off('click', '#btn_confirm_cancel').on('click', '#btn_confirm_cancel', function(e) {
                e.preventDefault();
                // $(this).prop('disabled', true);
                let url = "{{ route('confirm.cancel.bill', ':id') }}";
                url = url.replace(':id', id);
                $.ajax({
                    type: "POST",
                    url: url,
                    data: { _token: "{{ csrf_token() }}",  },
                    success: function (res) {
                        if(res.message.cancelInvResult == 'OK:') {
                            alert('Đã Hủy Hóa đơn thành công');
                            $('#btn_confirm_cancel').prop('disabled', false);
                            $('#modal_cancel').modal('hide');
                            $('#btn_refresh_input_search').click();
                        } else {
                            alert(res.message.cancelInvResult);
                            $('#btn_confirm_cancel').prop('disabled', false);
                            $('#modal_cancel').modal('hide');
                        }
                    }
                });
            });
        }); 
    });
</script>
@endsection
