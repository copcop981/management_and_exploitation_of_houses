@extends('admins.layouts.master')

@section('title')
    Quản lý bán vé - Trung tâm quản lý và khai thác nhà Đà Nẵng
@endsection

@section('style')
<style>
    #_1, 
    #_2 {
        position: relative;
    }

    #_1::after, 
    #_2::after {
        content: "";
        position: absolute;
        width: calc(100% - 1.1rem);
        height: 1px;
        background-color: #ddd;
    }

    #_1::after {
        bottom: 0;
    }

    #_2::after {
        bottom: 0;
    }

    table {
        min-width: max-content;
    }


    th {
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
        background: #333;
        position: sticky;
        top: 0;
        z-index: 999;
    }

    .table-wrapper {
        max-height: 450px;
        overflow: scroll;
    }
</style>
@endsection

@section('content')
<!--# Page header -->
<div class="page-header page-header-light">
    <div class="page-header-content header-elements-lg-inline">
        <div class="page-title d-flex"></div>
        <div class="header-elements d-none">
            <div class="d-flex justify-content-center">
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
            </div>
        </div>
    </div>
    <div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
        <div class="d-flex">
            <div class="breadcrumb">
                <a href="" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
                <a href="" class="breadcrumb-item">Vé xe</a>
                <span href="" class="breadcrumb-item active">Bán vé</span>
            </div>
            <a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
        </div>

    </div>
</div>
<!--# /page header -->

<div class="content">
    <div class="card mb-4">
        <div class="container mb-2">
            <div class="mt-2 text-center text-uppercase p-1 bg-primary text-light" style="width: 130px; border-radius: 5px 5px 0 0;">
                Bán vé thường
            </div>
            <div class="row">
                <div class="col-7">
                    <div class="p-1 pl-2 bg-primary text-light" style="border-radius: 0 5px 0 0;">Thông tin bán vé</div>
                    <div class="ml-4" id="_1">
                        <div class="row mt-2">
                            <div class="col-5 p-0">
                                <input type="text" class="form-control form-control-sm" id="ticket_infor" placeholder="Khách lẻ">
                            </div>
                            <div class="col-7">
                                <button type="button" class="btn btn-danger btn-sm text-uppercase float-right mr-4" id="btn_reset_ve">Nhập lại vé</button>
                            </div>
                        </div>
                        <div class="row mt-2">
                            @foreach ($ticketTypes as $ticketType)
                                <div class="col-5 mr-2 mb-2" style="height: 92px; border: 1px solid #ddd;">
                                    <div class="d-flex ticket_infor" style="position: relative;">
                                        <button type="button" value="{{ $ticketType->id }}" class="btn btn-info p-4 mt-2" id="btn_increase_{{ $ticketType->id }}" style="width: 70px !important; 
                                            height: 70px !important; 
                                            position: relative !important;">
                                            <i class="fa-solid fa-cart-shopping" style="position: absolute !important;
                                                top: 50% !important;
                                                left: 50% !important;
                                                transform: translate(-50%, -50%) !important;
                                            "></i>
                                            <span class="badge badge-pill badge-danger" id="ticket_quantity_{{ $ticketType->id }}" style="padding: 0.1125rem 0.2375rem !important;
                                            position: absolute !important;
                                            top: 5% !important;
                                            right: 5% !important;">0</span>
                                        </button>
                                        <div class="ml-2 mt-3">
                                            <span class="text-secondary text-uppercase" id="ticket_type_{{ $ticketType->id }}">{{ $ticketType->type }}</span>
                                            <div class="d-flex">
                                                <p class="mt-2 font-weight-bold" id="ticket_price_{{ $ticketType->id }}">{{ number_format($ticketType->price, 0, ',', '.') }}</p>
                                                <p class="mt-2 font-weight-bold">&nbsp;VND</p>
                                            </div>
                                        </div>
                                        <div class="mt-2" style="position: absolute; right: 0;">
                                            <a href="" data-id="{{ $ticketType->id }}" class="text-danger d-none" id="btn_decrease_{{ $ticketType->id }}">
                                                <i class="fas fa-minus-square"></i>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            @endforeach
                        </div>
                    </div>
                </div>
                <div class="col-5">
                    <div class="p-1 pl-2 bg-primary text-light" style="border-radius: 5px 5px 0 0;">Thông tin bán vé</div>
                    <div class="ml-4 pb-2" id="_2">
                        <div class="row mt-2">
                            <div class="col-6">
                                <p class="font-weight-bold">Tổng tiền vé:</p>
                            </div>
                            <div class="col-6">
                                <p id="total_amount_ticket">0</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <p>Khách phải trả:</p>
                            </div>
                            <div class="col-6">
                                <p id="total_amount_cus_must_pay">0</p>
                            </div>
                        </div>
                        <div class="row align-items-center">
                            <div class="col-6">
                                <p>Khách thanh toán:</p>
                            </div>
                            <div class="col-5">
                                <input type="text" name="" id="total_amount_cus_pay" class="form-control form-control-sm">
                            </div>
                        </div>
                        <hr class="mt-3 mb-2">
                        <div class="row">
                            <div class="col-6">
                                <p>Tiền thừa cần trả khách:</p>
                            </div>
                            <div class="col-5">
                                <p id="excess_amount">0</p>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6"></div>
                            <div class="col-5">
                                <button type="button" class="btn btn-primary btn-sm text-uppercase" id="btn_purchase">Thanh toán</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="p-1 pl-2 bg-primary text-light" style="border-radius: 5px 5px 0 0;">
                    <span>Thông tin bán vé:</span>
                    <span id="ticket_issuing_time">{{ \Carbon\Carbon::now()->format('d/m/Y') }}</span>
                </div>
                <div class="mt-1 d-flex justify-content-between">
                    <div>
                        <select name="" class="form-control custom-select custom-select-sm" id="row">
                            <option value="5">5 hàng</option>
                            <option value="10">10 hàng</option>
                            <option value="15">15 hàng</option>
                            <option value="20">20 hàng</option>
                        </select>
                    </div>
            
                    <div class="d-flex align-items-center">
                        <span style="width: 80px;">Tìm kiếm:</span>
                        <div style="display: flex; position: relative;">
                            <input type="text" name="" id="input_search" class="form-control form-control-sm">
                            <a href="" class="d-none" id="btn_refresh_input_search">
                                <i class="fa-solid fa-xmark" style="position: absolute;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    right: 0;
                                    padding: 10px;
                                    font-size: 16px;
                                    cursor: pointer;
                                    color: #868686;">
                                </i>
                            </a>
                        </div>
                        <button type="button" class="btn btn-success btn-sm" id="btn_search" style="margin-left: 0.5rem !important;">
                            <i class="fa-solid fa-magnifying-glass mr-1"></i>
                            Tìm kiếm
                        </button>
                    </div>
                </div>
                <div id="list_ticket_table">
                    @include('admins.tickets.sale.pagination')
                </div>
            </div>

            {{-- Modal Xác nhận thanh toán --}}
            <div class="modal fade" id="modal_confirm_purchase" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">Xác nhận</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        </div>
                        <div class="modal-body">
                            <span class="ml-2">Xác nhận thông tin vé</span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-primary btn-sm" id="btn_confirm_purchase" style="margin-left: 0.25rem !important;">Xác nhận</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('script')
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        function checkQuantity(quantity, id) {
            if(parseFloat(quantity.text()) == 0) {
                $('#btn_decrease_' + id).removeClass('d-block');
                $('#btn_decrease_' + id).addClass('d-none');
            }
            else {
                $('#btn_decrease_' + id).removeClass('d-none');
                $('#btn_decrease_' + id).addClass('d-block');
            }
        }

        $(document).off('click', '.ticket_infor button').on('click', '.ticket_infor button', function(e) {
            e.preventDefault();
            let id = $(this).val();
            let price = parseFloat($('#ticket_price_' + id).text().split('.').join(''));
            let quantity = parseFloat($('#ticket_quantity_' + id).text());
            let totalAmountTicket = $('#total_amount_ticket');
            let totalAmountCusMustPay = $('#total_amount_cus_must_pay');

            $('#ticket_quantity_' + id).text(quantity + 1);
            checkQuantity($('#ticket_quantity_' + id), id);

            let sum = parseFloat(totalAmountTicket.text().split('.').join('')) + price;
            totalAmountTicket.text(new Intl.NumberFormat('vi-VN').format(sum) + ' VND');
            totalAmountCusMustPay.text(new Intl.NumberFormat('vi-VN').format(sum) + ' VND');
        });

        $(document).off('click', '.ticket_infor a').on('click', '.ticket_infor a', function(e) {
            e.preventDefault();
            let id = $(this).attr('data-id');
            let price = parseFloat($('#ticket_price_' + id).text().split('.').join(''));
            let quantity = parseFloat($('#ticket_quantity_' + id).text());
            let totalAmountTicket = $('#total_amount_ticket');
            let totalAmountCusMustPay = $('#total_amount_cus_must_pay');

            $('#ticket_quantity_' + id).text(quantity - 1);
            checkQuantity($('#ticket_quantity_' + id), id);

            let subR = parseFloat(totalAmountTicket.text().split('.').join('')) - price;
            totalAmountTicket.text(new Intl.NumberFormat('vi-VN').format(subR) + ' VND');
            totalAmountCusMustPay.text(new Intl.NumberFormat('vi-VN').format(subR) + ' VND');
        });

        // $(document).off('click', '#btn_increase_vexemay').on('click', '#btn_increase_vexemay', function(e) {
        //     e.preventDefault();
        //     let vexemayQuantity = $('#vexemay_quantity');
        //     let vexemayPrice = $('#vexemay_price');
        //     let totalAmountTicket = $('#total_amount_ticket');
        //     let totalAmountCusMustPay = $('#total_amount_cus_must_pay');

        //     quantity = parseFloat(vexemayQuantity.text());
        //     vexemayQuantity.text(quantity + 1);

        //     checkQuantity(vexemayQuantity);

        //     price = parseFloat(vexemayPrice.text().split('.').join(''));
        //     totalAmountTicket.text(new Intl.NumberFormat('vi-VN').format(price * (quantity + 1)) + ' VND');
        //     totalAmountCusMustPay.text(new Intl.NumberFormat('vi-VN').format(price * (quantity + 1)) + ' VND');
        // });

        // $(document).off('click', '#btn_decrease_vexemay').on('click', '#btn_decrease_vexemay', function(e) {
        //     e.preventDefault();
        //     let vexemayQuantity = $('#vexemay_quantity');
        //     let vexemayPrice = $('#vexemay_price');
        //     let totalAmountTicket = $('#total_amount_ticket');
        //     let totalAmountCusMustPay = $('#total_amount_cus_must_pay');

        //     quantity = parseFloat(vexemayQuantity.text());
        //     vexemayQuantity.text(quantity - 1);

        //     checkQuantity(vexemayQuantity);

        //     price = parseFloat(vexemayPrice.text().split('.').join(''));
        //     totalAmountTicket.text(new Intl.NumberFormat('vi-VN').format(price * (quantity - 1)) + ' VND');
        //     totalAmountCusMustPay.text(new Intl.NumberFormat('vi-VN').format(price * (quantity - 1)) + ' VND');
        // });

        $(document).off('input', '#total_amount_cus_pay').on('input', '#total_amount_cus_pay', function(e) {
            let totalAmountCusMustPay = $('#total_amount_cus_must_pay');
            let totalAmountCusPay = $('#total_amount_cus_pay');
            let excessAmount = $('#excess_amount');
            totalAmountCusMustPay = totalAmountCusMustPay.text().split(' ')[0].split('.').join('');
            if(parseFloat(totalAmountCusPay.val()) < parseFloat(totalAmountCusMustPay)) excessAmount.text('Chưa đủ');
            else if (totalAmountCusPay.val() == '') excessAmount.text('0');
            else 
                excessAmount.text(new Intl.NumberFormat('vi-VN').format(parseFloat(totalAmountCusPay.val()) - parseFloat(totalAmountCusMustPay)) + ' VND');
        });

        $(document).off('click', '#btn_reset_ve').on('click', '#btn_reset_ve', function(e) {
            e.preventDefault();
            let ticketInfor = $('#ticket_infor');
            let ticketQuantity = $('span[id*="ticket_quantity"]');
            let btnDecreaseTicket = $('.ticket_infor a');
            let totalAmountTicket = $('#total_amount_ticket');
            let totalAmountCusMustPay = $('#total_amount_cus_must_pay');
            let totalAmountCusPay = $('#total_amount_cus_pay');
            let excessAmount = $('#excess_amount');
            
            btnDecreaseTicket.removeClass('d-block');
            btnDecreaseTicket.addClass('d-none');
            ticketInfor.val('');
            ticketQuantity.text('0');
            totalAmountTicket.text('0');
            totalAmountCusMustPay.text('0');
            totalAmountCusPay.val('');
            excessAmount.text('0');
            $('#row').val('5').change();
        });

        $(document).off('click', '#btn_purchase').on('click', '#btn_purchase', function(e) {
            e.preventDefault();
            let totalAmountCusMustPay = $('#total_amount_cus_must_pay');
            let ids = [];
            let quantities = [];
            // let quantity;
            if(parseFloat(totalAmountCusMustPay.text()) == 0) {
                alert('Vui lòng chọn loại vé');
                return;
            } else {
                $('.ticket_infor button').each(function() {
                    let idss = {};
                    let id = $(this).val();
                    let quantity = $('#ticket_quantity_' + id);
                    // type = $('#ticket_type_' + id);
                    // price = $('#ticket_price_' + id);
                    
                    if(parseFloat(quantity.text()) > 0) {
                        idss.id = id;
                        idss.quantity = quantity.text();
                        ids.push(idss);
                    }
                });
                $('#modal_confirm_purchase').modal('show');
            }
            
            $(document).prop('disabled', false).off('click', '#btn_confirm_purchase').on('click', '#btn_confirm_purchase', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                let ticketInfor = $('#ticket_infor');
                // let ticketTypeId = $('#ticket_type_id');
                // let ticketType = $('#ticket_type');
                // let vexemayPrice = $('#vexemay_price');
                // let quantity = $('#vexemay_quantity');
                $.ajax({
                    type: "POST",
                    url: "{{ route('ticket.store') }}",
                    data: {
                        ticketInfor: ticketInfor.val() != '' ? ticketInfor.val() : 'Khách lẻ',
                        // ticketTypeId: ticketTypeId.val(),
                        // ticketType: ticketType.text(),
                        // vexemayPrice: vexemayPrice.text().split('.').join(''),
                        // quantity: quantity.text(),
                        ids: ids,
                        // quantities: quantities,
                        _token: "{{ csrf_token() }}",
                    },
                    success: function (res) {
                        if(res.status == 200 || res.status == 400) {
                            let billQuantity = 0;
                            for(let i = 0; i < ids.length; i++) {
                                billQuantity += parseInt(ids[i]['quantity']);
                            }
                            alert('Đã xuất thành công ['+ billQuantity +'] hóa đơn.\n'+ res.message.ImportAndPublishInvResult);
                            $('#btn_confirm_purchase').prop('disabled', false);
                            $('#modal_confirm_purchase').modal('hide');
                            $('#btn_reset_ve').click();
                        }
                    }
                });
            });
        });

        $(document).off('click', '#btn_refresh_input_search').on('click', '#btn_refresh_input_search', function(e) {
            e.preventDefault();
            $('#input_search').val('');
            $(this).removeClass('d-inline');
            $(this).addClass('d-none');
            $('#input_search').trigger('focus');
        }); 

        let search = $('#input_search');
        $(document).off('input', '#input_search').on('input', '#input_search', function() {
            if($(this).val() != '') {
                $('#btn_refresh_input_search').removeClass('d-none');
                $('#btn_refresh_input_search').addClass('d-inline');
            } else {
                $('#btn_refresh_input_search').removeClass('d-inline');
                $('#btn_refresh_input_search').addClass('d-none');
            }
        });

        $(document).off('click', '.pagination a').on('click', '.pagination a', function(e) {
            e.preventDefault();
            let page = $(this).attr('href').split('?page=')[1];
            let numRow = $('#row').val();
            $.ajax({
                url: "/admins/ticket/sale/fetch?page=" + page,
                data: {
                    numRow: numRow > 0 ? numRow : 0,
                    search: search.val(),
                },
                success: function (res) {
                    $('#list_ticket_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });

        $(document).off('change', '#row').on('change', '#row', function() {
            if($(this).val() == '5') {
                search.val('');
                $('#btn_refresh_input_search').removeClass('d-inline');
                $('#btn_refresh_input_search').addClass('d-none');
            }
            let numRow = $(this).val();
            $.ajax({
                url: "{{ route('get.row.ticket.sale') }}",
                data: {
                    search: search.val(),
                    numRow: numRow,
                },
                success: function (res) {
                    $('#list_ticket_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });

        $(document).prop('disabled', false).off('click', '#btn_search').on('click', '#btn_search', function (e) {
            e.preventDefault();
            $(this).prop('disabled', true);
            $.ajax({
                type: "GET",
                url: "{{ route('ticket.sale.search') }}",
                data: { search: search.val() },
                success: function (res) {
                    $('#btn_search').prop('disabled', false);
                    $('#list_ticket_table').html(res);
                    $('#row').val('15');
                    // if(search.val() == '') 
                    //     $('#row').val('5').change();
                }
            });
        });
    });
</script>
@endsection
