@extends('admins.layouts.master')

@section('title')
    Quản lý công nợ
@endsection

@section('css')

@endsection

@section('style')
    <style>
        th, td {
            text-align: center;
        }

        th {
            min-width: 130px;
            height: 50px;
        }

        .modal-dialog {
            max-width: 90% !important;
            margin: 0 auto;
        }

        #review_table,
        #debt_divide_table {
            max-height: calc(100vh - 260px);
        }

        /* Review Modal*/
        #review_table tbody > tr > td {
            padding: 8px 20px 8px !important;
        }


        /* Debt Divide Modal */
        #debt_divide_table tbody > tr > td {
            padding: 5px !important;
        }

        #debt_divide_table tbody > tr > td > input {
            width: 100%;
            line-height: 2;
        }
    </style>
@endsection

@section('content')
    <!--# Page header -->
	<div class="page-header page-header-light">
		<div class="page-header-content header-elements-lg-inline">
			<div class="page-title d-flex"></div>
			<div class="header-elements d-none">
				<div class="d-flex justify-content-center">
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
				</div>
			</div>
		</div>
		<div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
			<div class="d-flex">
				<div class="breadcrumb">
					<a href="index.html" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
					<a href="alpaca_advanced.html" class="breadcrumb-item">Thu tiền</a>
					<!-- <span class="breadcrumb-item active">Trang 1</span> -->
				</div>
				<a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
			</div>

		</div>
	</div>
    <!--# /page header -->

	<!--# Content area -->
	<div class="content">
		<!--* Search Section -->
		<div class="card mb-4 pt-5">
            <div class="right-index pb-4">
                <div class="container !direction !spacing">
                    <fieldset class="border pl-2 pr-2 pb-2">
                        <legend style="border-bottom: unset; font-size: 20px; margin: 0;" class="w-auto">Tìm Kiếm</legend>
                        <form action="" method="GET">
                        	@csrf
                        	@method('GET')
                            <div class="row">
                                <div class="col-lg-12">
                                	<div class="row">
                                		<div class="col-lg-3">
		                                	<label>Tên chung cư:</label>
		                                    <input type="text" list="name_apartments" class="form-control" name="name_apartments" value="{{isset($params['name_apartments']) ? $params['name_apartments'] : ''}}" placeholder="" onkeyup="getBlockByApartmentID(this.value)" required>
		                                    {{-- @php 
		                                    	$apartments = getApartment();
		                                    @endphp --}}
		                                    <datalist id="name_apartments" class="" >
		                                    	{{-- @if ($apartments && count($apartments) > 0)
			                                    	@foreach ($apartments as $apartment)
				                                    	<option class="option_apartment">{{$apartment->name}}</option>
			                                    	@endforeach
		                                    	@endif --}}
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-3">
		                                	<label>Nhà:</label>
		                                    <input type="text" list="name_block" class="form-control" name="name_block" value="{{isset($params['name_block']) ? $params['name_block'] : ''}}" placeholder="" id="input_block" onkeyup="getRoomByBlockID(this.value)" required>
		                                    <datalist id="name_block" class="">
		                                    	
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-3">
		                                	<label>Mã căn hộ:</label>
		                                    <input type="text" list="name_rooms" class="form-control" name="code_room" value="{{isset($params['code_room']) ? $params['code_room'] : ''}}" placeholder="" id="input_room" required>
		                                    <datalist id="name_rooms" class="">
		                                    	
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-3">
		                                	<label>Lọc:</label>
		                                    <select name="" id=""class="form-control" disabled>
		                                    	<option value="">Mặc định</option>
		                                    	<option value="">Tất cả</option>
		                                    </select>
		                                </div>
		                                <div class="col-lg-3">
		                                    <label>&nbsp;</label>
                                            <button class="btn btn-primary form-control text-uppercase"><i class="fa">&#xf002;</i>&nbsp;Tìm kiếm</button>
		                                </div>

                                        <div class="col-lg-3">
		                                    <label>&nbsp;</label>
                                            <button type="button" class="btn btn-outline-success form-control text-uppercase" id="btn_review_modal" data-toggle="modal" data-target="#review_modal">
                                                <i class="fa-solid fa-check-to-slot"></i>
                                                &nbsp;Modal Duyệt (Demo)
                                            </button>
		                                </div>

                                        <div class="col-lg-3">
		                                    <label>&nbsp;</label>
                                            <button type="button" class="btn btn-outline-warning form-control text-uppercase" id="btn_debt_divide_modal" data-toggle="modal" data-target="#debt_divide_modal">
                                                <i class="fa">&#xf002;</i>
                                                &nbsp;Modal Tách (Demo)
                                            </button>
		                                </div>
                                	</div>	
                                </div>
                            </div>
                        </form>

                        {{-- Modal Duyệt --}}
                        <div class="modal fade" id="review_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Duyệt Biên lai / Phiếu thu</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="d-flex justify-content-end">
                                            <strong style="font-size: 17px;">Loại: </strong>
                                            <strong style="font-size: 17px; color: #ff0000;">&nbsp;{{ $debtControls[0]->managePaidMoney->unitPrice->typePrice->typeReceipt->type }}</strong>
                                        </div>

                                        <div class="row">
                                            <div class="col-12">
                                                <strong style="font-size: 17px;">Thông tin hộ dân</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Tên chung cư: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->block->apartment->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Nhà: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->block->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Căn hộ: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Tên chủ hộ: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->household->fullname }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Thuộc đối tượng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->residentObject->title }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Ngày ký hợp đồng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->contract_signing_date }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Trạng thái: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->roomStatus->title }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Tháng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">9/2022</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Tổng tiền thu: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;" id="total_paid_review">{{ number_format(20000000, 0, ',', '.') }}</strong>
                                            </div>

                                            <input type="hidden" name="household_id" value="{{ $debtControls[0]->household->id }}">
                                        </div>

                                        <div class="overflow-auto mt-2" id="review_table">
                                            <table class="table mb-1" border="1">
                                                <thead style="background-color: #212529; color: #fff;">
                                                    <tr>
                                                        <th scope="col" rowspan="3" style="min-width: 50px !important;">STT</th>
                                                        <th scope="col" rowspan="3">Đơn giá</th>
                                                        <th scope="col" rowspan="3" style="min-width: 50px !important;">Miễn giảm <br> (nếu có)</th>
                                                        <th scope="col" rowspan="3">ĐG sau <br> MG</th>
                                                        <th scope="col" colspan="7" class="text-center">SỐ DƯ ĐẦU KỲ</th>
                                                        <th scope="col" rowspan="3">Phải thu <br> (tháng này)</th>
                                                        <th scope="col" colspan="8" class="text-center">SỐ ĐÃ THU</th>
                                                    </tr>
                                                    <tr>
                                                        <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
                                                        <th scope="col" rowspan="2">Số còn <br> phải thu</th>
                                                        <th scope="col" colspan="2" class="text-center">Số thu trước</th>
                                                        <th scope="col" rowspan="2">Thu thừa</th>
                                
                                                        <th scope="col" rowspan="2">Đã thu <br> (tháng này)</th>
                                                        <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
                                                        <th scope="col" colspan="2" class="text-center">Số thu trước</th>
                                                        <th scope="col" rowspan="2">Thu thừa</th>
                                                        <th scope="col" rowspan="2">Tổng cộng</th>
                                                    </tr>
                                                    <tr>
                                                        <th scope="col">Năm nay</th>
                                                        <th scope="col">Năm sau</th>
                                
                                                        <th scope="col">Năm nay</th>
                                                        <th scope="col">Năm sau</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="review_table_data">
                                                    @if (isset($debtControls) && $debtControls->count() > 0)
                                                        @php $i = 1 @endphp
                                                        @php $j = 1 @endphp
                                                        @foreach ($debtControls as $debtControl)
                                                            <tr>
                                                                <td scope="row" class="text-center">{{ $i++ }}</td>
                                                                <td scope="row">{{ $debtControl->managePaidMoney->price == 0 ? '-' : number_format($debtControl->managePaidMoney->price, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->managePaidMoney->exemption == 0 ? '-' : $debtControl->managePaidMoney->exemption.'%' }}</td>
                                                                <td scope="row">{{ $debtControl->managePaidMoney->price_after_policy == 0 ? '-' : $debtControl->managePaidMoney->exemption > 0 ? number_format($debtControl->managePaidMoney->price - ($debtControl->managePaidMoney->price * $debtControl->managePaidMoney->exemption / 100), 0, ',', '.') : number_format($debtControl->managePaidMoney->price_after_policy, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->number_month_first_period == 0 ? '-' : $debtControl->number_month_first_period }}</td>
                                                                <td scope="row">{{ $debtControl->from_month_first_period == 0 ? '-' : $debtControl->from_month_first_period }}</td>
                                                                <td scope="row">{{ $debtControl->to_month_first_period == 0 ? '-' : $debtControl->to_month_first_period }}</td>
                                                                <td scope="row" class="outstanding_amount_first_period_review">{{ $debtControl->outstanding_amount_first_period == 0 ? '-' : $debtControl->managePaidMoney->exemption > 0 ? number_format(($debtControl->managePaidMoney->price - ($debtControl->managePaidMoney->price * $debtControl->managePaidMoney->exemption / 100) - $debtControl->managePaidMoney->amountPaid->price), 0, ',', '.') : number_format($debtControl->managePaidMoney->price_after_policy - $debtControl->managePaidMoney->amountPaid->price, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->revenue_before_this_year_first_period == 0 ? '-' : number_format($debtControl->revenue_before_this_year_first_period, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->revenue_before_next_year_first_period == 0 ? '-' : number_format($debtControl->revenue_before_next_year_first_period, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->excess_collection_first_period == 0 ? '-' : number_format($debtControl->excess_collection_first_period, 0, ',', '.') }}</td>
                                                                
                                                                @if ($j == 1)
                                                                    <td scope="row" rowspan="{{ $debtControls->count() }}" id="total_receivable_this_month_review">
                                                                    </td>
                                                                    <td scope="row" rowspan="{{ $debtControls->count() }}" id="total_paid_this_month_review">
                                                                    </td>
                                                                    @php $j = 0 @endphp
                                                                @endif

                                                                <td scope="row">{{ $debtControl->number_month_amount_received_detail == 0 ? '-' : $debtControl->number_month_amount_received_detail }}</td>
                                                                <td scope="row">{{ $debtControl->from_month_amount_received_detail == 0 ? '-' : $debtControl->from_month_amount_received_detail }}</td>
                                                                <td scope="row">{{ $debtControl->to_month_amount_received_detail == 0 ? '-' : $debtControl->to_month_amount_received_detail }}</td>
                                                                <td scope="row">{{ $debtControl->this_year_amount_received_detail == 0 ? '-' : number_format($debtControl->this_year_amount_received_detail, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->next_year_amount_received_detail == 0 ? '-' : number_format($debtControl->next_year_amount_received_detail, 0, ',', '.') }}</td>
                                                                <td scope="row">{{ $debtControl->excess_collection_amount_received_detail == 0 ? '-' : number_format($debtControl->excess_collection_amount_received_detail, 0, ',', '.') }}</td>
                                                                <td scope="row" class="sum_price_amount_received_review">{{ $debtControl->sum_price_amount_received_detail == 0 ? '-' : number_format($debtControl->sum_price_amount_received_detail, 0, ',', '.') }}</td>
                                                            </tr>
                                                        @endforeach
                                                    @endif
                                                </tbody>
                                            </table>
                                        </div>

                                        <div class="mt-2 col-lg-12">
                                            <button type="button" class="btn btn-outline-info w-100" id="btn_debt_divide_modal" data-toggle="modal" data-target="#debt_divide_modal">Tách nợ</button>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Đóng</button>
                                        <button type="button" class="btn btn-success pr-4 pl-4" id="btn_review">Duyệt</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {{-- Modal Tách nợ --}}
                        <div class="modal fade" id="debt_divide_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="exampleModalLongTitle">Tách nợ</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <div class="d-flex justify-content-end">
                                            <strong style="font-size: 17px;">Loại: </strong>
                                            <strong style="font-size: 17px; color: #ff0000;">&nbsp;{{ $debtControls[0]->managePaidMoney->unitPrice->typePrice->typeReceipt->type }}</strong>
                                        </div>

                                        <div class="row">
                                            <div class="col-12">
                                                <strong style="font-size: 17px;">Thông tin hộ dân</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Tên chung cư: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->block->apartment->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Nhà: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->block->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Căn hộ: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->room->name }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Tên chủ hộ: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->household->fullname }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Thuộc đối tượng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->residentObject->title }}</strong>
                                            </div>

                                            <div class="col-3">
                                                <strong style="font-size: 15px;">Ngày ký hợp đồng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->contract_signing_date }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Trạng thái: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">{{ $debtControls[0]->managePaidMoney->householdRoom->roomStatus->title }}</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Tháng: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;">9/2022</strong>
                                            </div>

                                            <div class="col-2">
                                                <strong style="font-size: 15px;">Tổng tiền thu: </strong>
                                                <strong style="font-size: 15px; color: #ff0000;" id="total_paid_debt_divide">{{ number_format(20000000, 0, ',', '.') }}</strong>
                                                <input type="hidden" id="total_paid_debt_divide_temp" value="20000000">
                                            </div>

                                            <input type="hidden" name="household_id" value="{{ $debtControls[0]->household->id }}">
                                        </div>

                                        <div class="overflow-auto mt-2" id="debt_divide_table">
                                            <table class="table mb-1" border="1">
                                                <thead style="background-color: #212529; color: #fff;">
                                                    <tr>
                                                        <th scope="col" rowspan="3" style="min-width: 50px !important;">STT</th>
                                                        <th scope="col" rowspan="3">Đơn giá</th>
                                                        <th scope="col" rowspan="3" style="min-width: 50px !important;">Miễn giảm <br> (nếu có)</th>
                                                        <th scope="col" rowspan="3">ĐG sau <br> MG</th>
                                                        <th scope="col" colspan="7" class="text-center text-uppercase">Số dư đầu kỳ</th>
                                                        <th scope="col" rowspan="3">Phải thu <br> (tháng này)</th>
                                                        <th scope="col" colspan="8" class="text-center text-uppercase">Số đã thu</th>
                                                    </tr>
                                                    <tr>
                                                        <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
                                                        <th scope="col" rowspan="2">Số còn <br> phải thu</th>
                                                        <th scope="col" colspan="2" class="text-center">Số thu trước</th>
                                                        <th scope="col" rowspan="2">Thu thừa</th>
                                
                                                        <th scope="col" rowspan="2">Đã thu <br> (tháng này)</th>
                                                        <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
                                                        <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
                                                        <th scope="col" rowspan="2">Thu trước năm nay</th>
                                                        <th scope="col" rowspan="2">Thu trước năm sau</th>
                                                        <th scope="col" rowspan="2">Thu thừa</th>
                                                        <th scope="col" rowspan="2">Tổng cộng</th>
                                                    </tr>
                                                    <tr>
                                                        <th scope="col">Năm nay</th>
                                                        <th scope="col">Năm sau</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="debt_divide_table_data">
                                                    @php $i = 1 @endphp
                                                    @php $j = 1 @endphp
                                                    @foreach ($debtControls as $debtControl)
                                                        <tr>
                                                            <td scope="row" class="text-center">{{ $i++ }}</td>
                                                            <td scope="row">{{ $debtControl->managePaidMoney->price == 0 ? '-' : number_format($debtControl->managePaidMoney->price, 0, ',', '.') }}</td>
                                                            <td scope="row">{{ $debtControl->managePaidMoney->exemption == 0 ? '-' : $debtControl->managePaidMoney->exemption.'%' }}</td>
                                                            <td scope="row">{{ $debtControl->managePaidMoney->price_after_policy == 0 ? '-' : $debtControl->managePaidMoney->exemption > 0 ? number_format($debtControl->managePaidMoney->price - ($debtControl->managePaidMoney->price * $debtControl->managePaidMoney->exemption / 100), 0, ',', '.') : number_format($debtControl->managePaidMoney->price_after_policy, 0, ',', '.') }}</td>
                                                            <td scope="row">{{ $debtControl->number_month_first_period == 0 ? '-' : $debtControl->number_month_first_period }}</td>
                                                            <td scope="row">{{ $debtControl->from_month_first_period == 0 ? '-' : $debtControl->from_month_first_period }}</td>
                                                            <td scope="row">{{ $debtControl->to_month_first_period == 0 ? '-' : $debtControl->to_month_first_period }}</td>
                                                            <td scope="row" class="outstanding_amount_first_period_debt_divide">{{ $debtControl->outstanding_amount_first_period == 0 ? '-' : $debtControl->managePaidMoney->exemption > 0 ? number_format(($debtControl->managePaidMoney->price - ($debtControl->managePaidMoney->price * $debtControl->managePaidMoney->exemption / 100) - $debtControl->managePaidMoney->amountPaid->price), 0, ',', '.') : number_format($debtControl->managePaidMoney->price_after_policy - $debtControl->managePaidMoney->amountPaid->price, 0, ',', '.') }}</td>
                                                            <td scope="row">{{ $debtControl->revenue_before_this_year_first_period == 0 ? '-' : number_format($debtControl->revenue_before_this_year_first_period, 0, ',', '.') }}</td>
                                                            <td scope="row">{{ $debtControl->revenue_before_next_year_first_period == 0 ? '-' : number_format($debtControl->revenue_before_next_year_first_period, 0, ',', '.') }}</td>
                                                            <td scope="row">{{ $debtControl->excess_collection_first_period == 0 ? '-' : number_format($debtControl->excess_collection_first_period, 0, ',', '.') }}</td>
                                    
                                                            @if ($j == 1)
                                                                <td scope="row" rowspan="{{ $debtControls->count() }}" id="total_receivable_this_month_debt_divide"></td>
                                                                @php $j = 0 @endphp
                                                            @endif
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="received_this_month" name="" min="1">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                    
                                                            <td scope="row">
                                                                <input type="number" id="" class="" name="">
                                                            </td>
                                                        </tr>
                                                    @endforeach
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Đóng</button>
                                        <button type="button" class="btn btn-success pr-4 pl-4" id="btn_divide_debt">Hoàn tất</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </fieldset>
                </div>
                <!--end of line -->
                {{-- @if ($user_rooms && count($user_rooms) > 0)  
                <div class="container" style="padding-top: 30px;">
                    <h4>Danh Sách</h4>                  
                    <table class="table table-bordered" style=" box-shadow: 1px 4px 10px 1px;">
                        <thead>
                            <tr>
                                <th class="text-center text-uppercase" width="10%">STT</th>
                                <th class="text-center text-uppercase">Tên chủ hộ</th>
                                <th class="text-center text-uppercase" width="30%">Tổng số tiền đang nợ <br> (đồng)</th>
                            </tr>
                        </thead>
                        <tbody>
                        	@foreach ($user_rooms as $key => $value)
                        	@php $user = $value->user;  @endphp
                        	@if(isset($user))
                        	@php $sumPrice = getDetailPriceByUserID('', $user->id, $value->code_room);  @endphp
                        	@if ($sumPrice != 0)
                            <tr>
                                <td class="text-center">{{$key + 1}}</td>
                                <td class="text-left"><a class="text-link-detail" href="{{route('get.collect-money.id',['code_room' => $value->code_room, 'user_id' => $value->user_id, 'url' => url()->full()])}}"> {{$user->fullname}}</a></td>
                                <td class="text-right">{{number_format($sumPrice, 0, ',', '.')}}</td>
                            </tr>
                            @endif
                            @endif
                            @endforeach
                        </tbody>
                    </table>
                </div>
                @endif --}}
                <!-- <div class="paging row justify-content-md-center">
                    <nav aria-label="Page navigation example">
                        <ul class="pagination">
                            <li class="page-item"><a class="page-link" href="#">Trước</a></li>
                            <li class="page-item"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                        </ul>
                    </nav>
                </div> -->
            </div>
        </div>
		<!--* /search Section -->
	</div>
	<!--# /content area -->

@endsection

@section('script')
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            function fetchData() {
                $.ajax({
                    url: "{{ route('debt-controls.fetch') }}",
                    type: "GET",
                    success: function (response) {
                        $('#review_table_data').html('');
                        $('#review_table_data').html(response);
                    }
                });
            }

            // function customFloatType(number){
            //     if(isNaN(parseFloat(number)) === false){
            //         let toFixedLength = 0;
            //         // let str = String(number);

            //         [".", ","].forEach(seperator=>{
            //             let arr = str.split(seperator);
            //             if( arr.length === 2 ){
            //                 toFixedLength = arr[1].length;
            //             }
            //         });
            //         return parseFloat(number).toFixed(toFixedLength);
            //     }
            // }

            $('#review_modal').on('shown.bs.modal', function() {
                let totalOfReceivableThisMonthReview = $('#total_receivable_this_month_review');
                let totalOfPaidThisMonthReview = $('#total_paid_this_month_review');
                let totalPaidReview = $('#total_paid_review');
                let outstandingAmountFirstPeriodReview = $('.outstanding_amount_first_period_review');
                let sumPriceAmountReceived = $('.sum_price_amount_received_review');
                
                let sum = 0;
                let allOutstandingAmountFirstPeriodReview = [];
                outstandingAmountFirstPeriodReview.each(function() {
                    allOutstandingAmountFirstPeriodReview.push($(this).html().trim().split('.').join(''));
                    sum += parseFloat($(this).html().trim().split('.').join(''));
                });
                totalOfReceivableThisMonthReview.html(new Intl.NumberFormat('vi-VN').format(sum));

                sum = 0;
                sumPriceAmountReceived.each(function() {
                    sum += parseFloat($(this).html().trim().split('.').join(''));
                });
                totalOfPaidThisMonthReview.text(new Intl.NumberFormat('vi-VN').format(sum));

                if(totalPaidReview.html().trim() < totalOfReceivableThisMonthReview.html().trim() || 
                    totalPaidReview.html().trim() > totalOfReceivableThisMonthReview.html().trim() &&
                    totalOfReceivableThisMonthReview.html().trim() != 0) {
                    totalOfReceivableThisMonthReview.addClass('border border-danger text-danger');
                }

                $('#btn_review').on('click', function(e) {
                    e.preventDefault();
                    $(this).text('Đang duyệt');
                    let householdId = $('input[name="household_id"]').val();
                    
                    let url = '{{ route("debt-controls.update", ":id") }}';
                    url = url.replace(':id', householdId);

                    if(totalPaidReview.html().trim() == totalOfReceivableThisMonthReview.html().trim()) {
                        $.ajax({
                            url: url,
                            type: "PATCH",
                            data: {
                                householdId: householdId,
                                allOutstandingAmountFirstPeriodReview: allOutstandingAmountFirstPeriodReview,
                                _token: '{{ csrf_token() }}',
                            },
                            dataType: "json",
                            success: function (response) {
                                if(response.status == 200) {
                                    $('#review_modal').modal('hide');
                                    $('#btn_review').text('Duyệt');
                                    fetchData();
                                }
                            }
                        });
                    } else {
                        setTimeout(() => {
                            $('#btn_review').text('Duyệt');
                        }, 1000);
                    }
                });
            });

            $('#review_modal').on('hidden.bs.modal', function() {
                $('#btn_review').text('Duyệt');
            });

            $('#debt_divide_modal').on('shown.bs.modal', function() {
                $('#review_modal').modal('hide');
                let totalOfReceivableThisMonthDebtDivide = $('#total_receivable_this_month_debt_divide');
                let outstandingAmountFirstPeriodDebtDivide = $('.outstanding_amount_first_period_debt_divide');

                let sum = 0;
                outstandingAmountFirstPeriodDebtDivide.each(function() {
                    sum += parseFloat($(this).html().trim().split('.').join(''));
                });
                totalOfReceivableThisMonthDebtDivide.html(new Intl.NumberFormat('vi-VN').format(sum));

                $('.received_this_month').on('keydown', function(e) {
                    if(e.keyCode === 110 || e.keyCode === 190 
                    || e.keyCode === 107 || e.keyCode === 109 
                    || e.keyCode === 187 || e.keyCode === 188 
                    || e.keyCode === 189) e.preventDefault();

                    $(document).on('input', '.received_this_month', function(e) {
                        let totalPaidDebtDivide = $('#total_paid_debt_divide');
                        let totalPaidDebtDivideTemp = $('#total_paid_debt_divide_temp');

                        let sum = 0;
                        $('.received_this_month').each(function() {
                            sum += +$(this).val();

                            if(sum > parseFloat(totalPaidDebtDivideTemp.val())) 
                                $(this).addClass('text-danger');
                            else $(this).removeClass('text-danger');
                        });
                        let floatTotalPaidDebtDivide = parseFloat(totalPaidDebtDivide.text());
                        floatTotalPaidDebtDivide = parseFloat(totalPaidDebtDivideTemp.val()) - sum;
                        totalPaidDebtDivide.text(new Intl.NumberFormat('vi-VN').format(floatTotalPaidDebtDivide));
                    });
                });
            });

            $('#btn_divide_debt').click(function(e) {
                e.preventDefault();
                
                let sum = 0;
                // $('.received_this_month').each(function() {
                //     sum += parseFloat($('.received_this_month').val());
                // });
                
                let a = $('.received_this_month');

                for(let i = 0; i < a.length; i++) {
                    alert(a.val()[i]);
                }
                // alert(sum);
            });

            $('#debt_divide_modal').on('hidden.bs.modal', function() {
                // $('#review_modal').modal('show');
            });
        });
    </script>
@endsection
