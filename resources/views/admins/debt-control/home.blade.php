@extends('admins.layouts.master')

@section('title')
    Quản lý công nợ
@endsection

@section('css')

@endsection

@section('style')
    <style>
        th, td {
            text-align: center;
        }

        th {
            min-width: 130px;
            height: 50px;
        }

        .modal-dialog {
            max-width: 90% !important;
            margin: 0 auto;
        }

        #review_table,
        #debt_divide_table {
            max-height: calc(100vh - 260px);
        }

        /* Review Modal*/
        #review_table tbody > tr > td {
            padding: 8px 20px 8px !important;
        }


        /* Debt Divide Modal */
        #debt_divide_table tbody > tr > td {
            padding: 5px !important;
        }

        #debt_divide_table tbody > tr > td > input {
            width: 100%;
            line-height: 2;
        }
    </style>
@endsection

@section('content')
    <!--# Page header -->
	<div class="page-header page-header-light">
		<div class="page-header-content header-elements-lg-inline">
			<div class="page-title d-flex"></div>
			<div class="header-elements d-none">
				<div class="d-flex justify-content-center">
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
				</div>
			</div>
		</div>
		<div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
			<div class="d-flex">
				<div class="breadcrumb">
					<a href="/" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
					<a href="alpaca_advanced.html" class="breadcrumb-item">Quản lý công nợ</a>
					<!-- <span class="breadcrumb-item active">Trang 1</span> -->
				</div>
				<a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
			</div>

		</div>
	</div>
    <!--# /page header -->

	<!--# Content area -->
	<div class="content">
		<!--* Search Section -->
		<div class="card mb-4 pt-3">
            <div class="right-index pb-4">
            	<div class="row m-auto text-center">
            		<div class="col-lg-12">

 						<a href="#" class="badge badge-success"><i class="icon-file-excel"></i> Xuất Excel</a>


        				<a href="#" class="badge badge-danger"><i class="icon-lock2"></i> Khóa số đã thu</a>


        				<a href="#" class="badge badge-danger"><i class="icon-lock2"></i> Khóa công nợ</a>


        				<a href="#" class="badge badge-secondary"><i class="icon-list3"></i> </i> Xem công nợ đã khóa</a>


        				<a href="#" class="badge badge-success"><i class="icon-file-excel"></i> Xuất Excel công nợ đã khoá</a>

            		</div>
            		<div class="col-lg-12 mt-1">
 						<a href="#" class="badge badge-secondary"><i class="icon-search4"></i> Tra cứu lịch sử thu tiền của hộ dân</a>

        				<a href="#" class="badge badge-secondary"><i class="icon-search4"></i> Tra cứu quá trình miễn giảm chính sách của từng hộ dân</a>

            		</div>
            	</div>
                <div class="container !direction !spacing mt-1">
                    <fieldset class="border pl-2 pr-2 pb-2">
                        <legend style="border-bottom: unset; font-size: 20px; margin: 0;" class="w-auto">Tìm Kiếm</legend>
                        <form action="{{route('debt-controls.index')}}" method="GET">
                        	@csrf
                        	@method('GET')
                            <div class="row">
                                <div class="col-lg-8">
                                	<div class="row">
                                		<div class="col-lg-6">
		                                	<label>Tên chung cư:</label>
		                                    <input type="text" list="name_apartments" class="form-control" name="name_apartments" value="{{isset($params['name_apartments']) ? $params['name_apartments'] : ''}}" placeholder="" onkeyup="getBlockByApartmentID(this.value)">
		                                    @php 
		                                    	$apartments = getApartment();
		                                    @endphp
		                                    <datalist id="name_apartments" class="" >
		                                    	@if ($apartments && count($apartments) > 0)
			                                    	@foreach ($apartments as $apartment)
				                                    	<option class="option_apartment">{{$apartment->name}}</option>
			                                    	@endforeach
		                                    	@endif
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-6">
		                                	<label>Nhà:</label>
		                                    <input type="text" list="name_block" class="form-control" name="name_block" value="{{isset($params['name_block']) ? $params['name_block'] : ''}}" placeholder="" id="input_block" onkeyup="getFloorByBlockID(this.value)">
		                                    <datalist id="name_block" class="">
		                                    	
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-6">
		                                	<label>Tầng:</label>
		                                    <input type="text" list="name_floors" class="form-control" name="name_floors" value="{{isset($params['name_floors']) ? $params['name_floors'] : ''}}" placeholder="" id="input_floor" onkeyup="getRoomByFloorID(this.value)">
		                                    <datalist id="name_floors" class="">
		                                    	
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-6">
		                                	<label>Căn hộ:</label>
		                                    <input type="text" list="name_rooms" class="form-control" name="name_room" value="{{isset($params['name_room']) ? $params['name_room'] : ''}}" placeholder="" id="input_room">
		                                    <datalist id="name_rooms" class="">
		                                    	
		                                    </datalist>
		                                </div>
                                	</div>	
                                	<div class="row">
                                		<div class="col-lg-6">
		                                	<label>Tháng:</label>
		                                    <input type="text" list="name_month" class="form-control" name="name_month" value="{{isset($params['name_month']) ? $params['name_month'] : ''}}" required>
		                                    @php 
		                                    	$months = getMonth();
		                                    @endphp 
		                                    <datalist id="name_month" class="" >
		                                    	@if ($months && count($months) > 0)
			                                    	@foreach ($months as $month)
				                                    	<option class="option_apartment">{{$month->title}}</option>
			                                    	@endforeach
		                                    	@endif
		                                    </datalist>
		                                </div>
		                                <div class="col-lg-6">
		                                	<label>Năm:</label>
		                                    <input type="text" list="name_year" class="form-control" name="name_year" value="{{isset($params['name_year']) ? $params['name_year'] : ''}}" placeholder="" required>
		                                    @php 
		                                    	$years = getYear();
		                                    @endphp 
		                                    <datalist id="name_year" class="" >
		                                    	@if ($years && count($years) > 0)
			                                    	@foreach ($years as $year)
				                                    	<option class="option_apartment">{{$year->title}}</option>
			                                    	@endforeach
		                                    	@endif
		                                    </datalist>
		                                </div>
                                	</div>
                                </div>
                                <div class="col-lg-4">
                                	<div class="row">
                                		<div class="col-lg-12">
		                                	<label>Loại tiền:</label>
		                                	@php
		                                		$type_prices = getListTypePrice();
		                                	@endphp

		                                	@foreach ($type_prices as $key => $type_price)
		                                		<div class="form-check">
			                                      <input class="form-check-input" name="type_price[]" type="checkbox" value="{{$type_price->id}}" id="type{{$key+1}}" {{in_array($type_price->id,$params['type_price']) ? 'checked' : ''}}>
			                                      <label class="form-check-label" for="type{{$key+1}}">
			                                        {{$type_price->type}}
			                                      </label>
			                                    </div>
		                                	@endforeach
		                                </div>
		                                <div class="col-lg-12">
		                                    <label>&nbsp;</label>
                                            <button class="btn btn-primary form-control text-uppercase"><i class="fa">&#xf002;</i>&nbsp;Tìm kiếm</button>
		                                </div>
                                	</div>
                                </div>
                            </div>
                        </form>

                    </fieldset>
                </div>
                <div class="row text-right mt-3 mr-2">
            		<div class="col-lg-12">
 						<button href="#" class="btn btn-outline-info" data-toggle="modal" data-target="#exampleModal_duyet">Duyệt & Tách</button>
 						<button href="#" class="btn btn-outline-success" data-toggle="modal" data-target="#exampleModal_chinh_sua">Chỉnh sửa</button>
 						<button href="#" class="btn btn-info">Hiện & Ẩn cột</button>
            		</div>
            	</div>
                <!--end of line -->
                <div class="container" style="padding-top: 30px;">    
                	<h4>Danh sách</h4>              
                    <div class="overflow-auto">

                    	<table class="table mb-1" border="1">
	                        <thead class="thead-light">
	                            <tr>
	                            	<th scope="col" rowspan="3" style="min-width: 50px !important;"></th>
	                                <th scope="col" rowspan="3" style="min-width: 50px !important;">STT</th>
	                                <th scope="col" rowspan="3" style="min-width: 50px !important;">Đối tượng</th>
	                                <th scope="col" rowspan="3">Chủ hộ</th>
	                                <th scope="col" rowspan="3" style="min-width: 80px !important;">Căn hộ</th>
	                                <th scope="col" rowspan="3" style="min-width: 80px !important;">Ngày ký HĐ</th>
	                                <th scope="col" rowspan="3" style="min-width: 50px !important;">Trạng thái</th>
	                                <th scope="col" rowspan="3">Đơn giá</th>
	                                <th scope="col" rowspan="3" style="min-width: 50px !important;">Loại tiền</th>
	                                <th scope="col" rowspan="3" style="min-width: 50px !important;">Miễn giảm <br> (nếu có)</th>
	                                <th scope="col" rowspan="3">ĐG sau <br> MG</th>
	                                <th scope="col" colspan="7" class="text-center text-uppercase">Số dư đầu kỳ</th>
	                                <th scope="col" colspan="6" class="text-center text-uppercase">Số phải thu phát sinh</th>
	                                <th scope="col" colspan="7" class="text-center text-uppercase">Số đã thu</th>
	                                <th scope="col" colspan="3" class="text-center text-uppercase">Điều chỉnh số đã thu</th>
	                                <th scope="col" colspan="7" class="text-center text-uppercase">Số dư cuối kì</th>
	                                <th scope="col" rowspan="3" class="text-center text-uppercase">Ghi chú</th>
	                            </tr>
	                            <tr>
	                            	<!-- Số dư đầu kì -->
	                                <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
	                                <th scope="col" rowspan="2">Số còn <br> phải thu</th>
	                                <th scope="col" colspan="2" class="text-center">Số thu trước</th>
	                                <th scope="col" rowspan="2">Thu thừa</th>
	                                <!-- end số dư đầu kì -->

	                                <!-- Số phải thu phát sinh -->
	                                <th scope="col" rowspan="2">Số phải thu</th>

	                                <th scope="col" rowspan="2">Số phải thu hộ giải tỏa chưa nộp tiền</th>

	                                <th scope="col" rowspan="2">Truy thu</th>

	                                <th scope="col" rowspan="2">Ghi chú <br> (Truy thu)</th>

	                                <th scope="col" rowspan="2">Giảm trừ</th>

	                                <th scope="col" rowspan="2">Ghi chú <br> (Giảm trừ)</th>
	                                <!-- end số phải thu phát sinh -->
	                                <!-- Số đã thu -->
	                                <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
	                                <th scope="col" rowspan="2">Năm nay</th>
	                                <th scope="col" rowspan="2">Năm sau</th>
	                                <th scope="col" rowspan="2">Thu thừa</th>
	                                <th scope="col" rowspan="2">Tổng cộng</th>
	                                <!-- end số đã thu -->
	                                <!-- điều chỉnh số đã thu -->
	                                <th scope="col" rowspan="2">Năm nay</th>
	                                <th scope="col" rowspan="2">Năm sau</th>
	                                <th scope="col" rowspan="2">Thu thừa</th>
	                                <!-- end điều chỉnh số đã thu -->

	                                <!-- Số dư cuối kì -->
	                                <th scope="col" rowspan="2" style="min-width: 50px !important;">Số tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Từ tháng</th>
	                                <th scope="col" rowspan="2" style="min-width: 80px !important;">Đến tháng</th>
	                                <th scope="col" rowspan="2">Số còn <br> phải thu</th>
	                                <th scope="col" colspan="2" class="text-center">Số thu trước</th>
	                                <th scope="col" rowspan="2">Thu thừa</th>
	                                <!-- end số dư cuối kì -->
	                            </tr>
	                            <tr>
	                            	<!-- số dư đầu kì -->
	                                <th scope="col">Năm nay</th>
	                                <th scope="col">Năm sau</th>
	                                <!-- end số dư đầu kì -->
	                                <!-- sô dư cuối kì -->
	                                <th scope="col">Năm nay</th>
	                                <th scope="col">Năm sau</th>
	                                <!-- end số dư cuối kì -->
	                            </tr>
	                        </thead>
	                        <tbody>
	                        	@if ($debt_control_generals && count($debt_control_generals) > 0)
	                        	@foreach ($debt_control_generals as $key => $debt_control_general)
	                        	@php $debt_control_details = $debt_control_general->debtControlDetail; @endphp
	                        	@foreach ($debt_control_details as $key1 => $debt_control_detail)
	                        	<tr style="background-color: {{($key % 2 != 0) ? '#FFFFCC' : ''}}; ">
	                        		@if ($key1 == 0)
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}"><input type="checkbox" name="debt_control_general_id[]" value="{{$debt_control_general->id}}" onclick="setSessionDebtControlGeneral()" class="debt_control_general_id"></td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$key+1}}</td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->household_room->residentObject->title}}</td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->household_room->household->fullname}}</td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->household_room->room->name}}</td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->household_room->contract_signing_date}}</td>
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}"></td>
	                        		@endif
	                        		<td>{{$debt_control_detail->price > 0 ? number_format($debt_control_detail->price, 0, ',', '0') : 'Nợ truy thu'}}</td>
	                        		<td>{{$debt_control_detail->typePrice->type}}</td>
	                        		<td>{{$debt_control_detail->exemption}}%</td>
	                        		<td>{{ number_format($debt_control_detail->price_after_policy, 0, ',', '.')}}</td>
	                        		<td>{{$debt_control_detail->number_month_first_period}}</td>
	                        		<td>{{$debt_control_detail->from_month_first_period}}</td>
	                        		<td>{{$debt_control_detail->to_month_first_period}}</td>
	                        		<td>{{ number_format($debt_control_detail->outstanding_amount_first_period, 0, ',', '.')}}</td>
	                        		<td>{{ number_format($debt_control_detail->revenue_before_this_year_first_period, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->revenue_before_next_year_first_period, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->excess_collection_first_period, 0, ',', '.')}}</td>
	                        		@if ($key1 == 0)
	                        		<td rowspan="{{$debt_control_details->count()}}">{{ number_format($debt_control_general->receivable, 0, ',', '.')}}</td>
	                        		<td rowspan="{{$debt_control_details->count()}}">
	                        		{{ number_format($debt_control_general->unpaid_receivable_relieve, 0, ',', '.')}}</td>
	                        		<td rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->arrears}}</td>
	                        		<td rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->note_arrears}}</td>
	                        		<td rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->reduce}}</td>
	                        		<td rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->note_reduce}}</td>
	                        		@endif
	                        		<td>{{$debt_control_detail->number_month_amount_received_detail}}</td>
	                        		<td>{{$debt_control_detail->from_month_amount_received_detail}}</td>
	                        		<td>{{$debt_control_detail->to_month_amount_received_detail}}</td>
	                        		<td>
	                        		{{number_format($debt_control_detail->this_year_amount_received_detail, 0, ',', '.')}}</td>
	                        		<td>
	                        		{{number_format($debt_control_detail->next_year_amount_received_detail, 0, ',', '.')}}</td>
	                        		<td>
	                        		{{number_format($debt_control_detail->excess_collection_amount_received_detail, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->sum_price_amount_received_detail, 0, ',', '.')}}</td>
	                        		<td>{{$debt_control_detail->adjust_this_year}}</td>
	                        		<td>{{$debt_control_detail->adjust_next_year}}</td>
	                        		<td>{{$debt_control_detail->adjust_excess_collection}}</td>
	                        		<td>{{$debt_control_detail->number_month_last_period}}</td>
	                        		<td>{{$debt_control_detail->from_month_last_period }}</td>
	                        		<td>{{$debt_control_detail->to_month_last_period }}</td>
	                        		<td>
	                        		{{number_format($debt_control_detail->outstanding_amount_last_period, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->revenue_before_this_year_last_period, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->revenue_before_next_year_last_period, 0, ',', '.')}}</td>
	                        		<td>{{number_format($debt_control_detail->excess_collection_last_period, 0, ',', '.')}}</td>
	                        		@if ($key1 == 0)
	                        		<td scope="col" rowspan="{{$debt_control_details->count()}}">{{$debt_control_general->note_debt_control_general}}</td>
	                        		@endif
	                        	</tr>
	                        	@endforeach
	                        	@endforeach
	                        	@else
	                        	<tr>
	                        		<td colspan="41" rowspan="" headers="">Không có dữ liệu</td>
	                        	</tr>
	                        	@endif
	                        </tbody>            
	                    </table>
                    </div>
                </div>
                <div class="row">
                        <div class="col-lg-12 mt-4 mb-1 pl-1">
                            <div class="clearfix">
                                <nav aria-label="Page navigation example" class="pull-right navigation">
                                    {!! $debt_control_generals->appends(Request::all())->links('helpers.paginate') !!}
                                </nav>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
		<!--* /search Section -->
		@include('admins.debt-control.modal-chinh-sua')
		@include('admins.debt-control.modal-duyet')
		@include('admins.debt-control.modal-tach')
	</div>
	<!--# /content area -->

@endsection

@section('script')
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script type="text/javascript">
    	function getBlockByApartmentID($name) {

    		var name_block = $('#name_block');
    		var input_block = $('#input_block');

    		input_block.val('');
    		name_block.empty();

            $.ajax({
                type: 'GET',

                data: {
                    'name': $name
                },
                url: '{{route('get.block.id.apartment')}}',

                success: function (data) {

                	name_block.empty();

                	name_block.append(data);

                },
                error: function (error) {

                }
            });
        }

        function getRoomByFloorID($name) {

    		var name_rooms = $('#name_rooms');
    		var input_room = $('#input_room');

    		input_room.val('');
    		name_rooms.empty();

            $.ajax({
                type: 'GET',

                data: {
                    'name': $name
                },
                url: '{{route('get.room.id.floor')}}',

                success: function (data) {

                	name_rooms.empty();

                	name_rooms.append(data);

                },
                error: function (error) {

                }
            });
        }

        function getFloorByBlockID($name) {

    		var name_floors = $('#name_floors');
    		var input_floor = $('#input_floor');

    		input_floor.val('');
    		name_floors.empty();

            $.ajax({
                type: 'GET',

                data: {
                    'name': $name
                },
                url: '{{route('get.floor.id.block')}}',

                success: function (data) {

                	name_floors.empty();

                	name_floors.append(data);

                },
                error: function (error) {

                }
            });
        }
    </script>
    <script type="text/javascript">
    	function setSessionDebtControlGeneral() {

    		var debt_control_general_id = $('.debt_control_general_id');

    		var modal_chinh_sua = $('#modal_chinh_sua');

    		var modal_duyet = $('#modal_duyet');

    		var modal_tach = $('#modal_tach');

    		var arr_id = [];  		

    		for (var i = 0; i < debt_control_general_id.length; i++) {

    			if (debt_control_general_id[i].checked === true) {

    				arr_id.push(debt_control_general_id[i].value);	
    				
    			}

    		}

    		$.ajax({
                type: 'GET',

                data: {
                    'arr_id': arr_id
                },
                url: '{{route('get.debt.arr.id.update')}}',

                success: function (data) {

                	modal_chinh_sua.html(data);

                },
                error: function (error) {

                }
            });

            $.ajax({
                type: 'GET',

                data: {
                    'arr_id': arr_id
                },
                url: '{{route('get.debt.id.approval')}}',

                success: function (data) {

                	modal_duyet.html(data);

                },
                error: function (error) {

                }
            });
    		
    		$.ajax({
                type: 'GET',

                data: {
                    'arr_id': arr_id
                },
                url: '{{route('get.debt.id.tach')}}',

                success: function (data) {

                	modal_tach.html(data);

                },
                error: function (error) {

                }
            });
    	}
    </script>
@endsection
