@extends('admins.layouts.master')

@section('title')
    Chỉnh sửa hóa đơn
@endsection

@section('style')
    <style>
        #receipt_table {
            counter-reset: serial-number !important;
        }

        #receipt_table td:nth-child(2)::before {
            counter-increment: serial-number !important;
            content: counter(serial-number) !important;
        }

        .receipt_table_input {
            width: 100% !important;
            line-height: 1 !important;
            background-color: transparent !important;
            color: #fff !important;
            /* border: none !important; */
            /* outline: none !important; */
        }

        /* .custom-select {
            padding-top: 2px;
        } */
    </style>
@endsection

@section('content')
    <!--# Page header -->
	<div class="page-header page-header-light">
		<div class="page-header-content header-elements-lg-inline">
			<div class="page-title d-flex"></div>
			<div class="header-elements d-none">
				<div class="d-flex justify-content-center">
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
					<a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
				</div>
			</div>
		</div>
		<div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
			<div class="d-flex">
				<div class="breadcrumb">
					<a href="index.html" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
					<a href="alpaca_advanced.html" class="breadcrumb-item">Hóa đơn</a>
					<!-- <span class="breadcrumb-item active">Trang 1</span> -->
				</div>
				<a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
			</div>

		</div>
	</div>
    <!--# /page header -->

    <div class="content">
        <div class="card mb-4 pt-3">
            <div class="container mb-2">
                <h5 class="text-uppercase">Chỉnh sửa hóa đơn</h5>
                <input type="hidden" value="{{ $receipt->id }}" id="receipt_id">
        
                <div class="mt-2">
                    <div class="row">
                        <div class="col-2"></div>
                        <div class="col-10">
                            <div id="success_message" class="m-0">
        
                            </div>
                        </div>
                    </div>
                </div>
        
                <div class="mt-2">
                    <div class="row mb-2">
                        <div class="col-2">
                            <a href="{{ url('/admins/receipt') }}" class="btn btn-outline-success btn-sm" id="list_receipt_btn">
                                <i class="fa-solid fa-angles-left mr-1"></i>
                                Danh sách HĐ
                            </a>
                        </div>
                        <div class="col-10">
                            <button class="btn btn-warning btn-sm" id="refresh_input_receipt_form_btn">
                                <i class="fa-solid fa-rotate mr-1"></i>
                                Làm mới
                            </button>
                        </div>
                    </div>
                    <form action="" method="" id="receipt_form">
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="form_no" class="col-form-label-sm float-right">Mẫu số</label>
                                </div>
                                <div class="col-10">
                                    <div class="row">
                                        <div class="col-4">
                                            <select name="" id="form_no" class="form-control form-control-sm custom-select">
                                                <option value="1c21tnh" {{ $receipt->form_no == '1C21TNHH' ? 'selected' : '' }}>1C21TNH</option>
                                            </select>
                                        </div>
                                        <div class="col-1">
                                            <label for="serial_no" class="col-form-label-sm float-right">Ký hiệu</label>
                                        </div>
                                        <div class="col-3">
                                            <input type="text" name="" id="serial_no" class="form-control form-control-sm text-uppercase" value="{{ $receipt->serial_no }}">
                                        </div>
                                        <div class="col-1">
                                            <label for="receipt_no" class="col-form-label-sm float-right">Số HĐ</label>
                                        </div>
                                        <div class="col-3">
                                            <input type="number" name="" id="receipt_no" class="form-control form-control-sm" value="{{ $receipt->receipt_no }}">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="apartment" class="col-form-label-sm float-right">Tên chung cư</label>
                                </div>
                                <div class="col-10">
                                    <select name="" id="apartment" class="form-control form-control-sm custom-select">
                                        <option value="0">--- Chọn chung cư ---</option>
                                        @foreach ($apartments as $apartment)
                                            <option value="{{ $apartment->id }}" 
                                                @if($apartment->id == $receipt->householdRoom->room->floor->block->apartment->id)
                                                    selected
                                                @endif>
                                                {{ $apartment->name }}
                                            </option>
                                        @endforeach
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="block" class="col-form-label-sm float-right">Nhà</label>
                                </div>
                                <div class="col-10">
                                    <select name="" id="block" class="form-control form-control-sm custom-select">
                                        <option value="0">--- Chọn nhà ---</option>
                                        @foreach ($blocks as $block)
                                            <option value="{{ $block->id }}"
                                                @if ($block->id == $receipt->householdRoom->room->floor->block->id)
                                                    selected
                                                @endif>
                                                {{ $block->name }}
                                            </option>
                                        @endforeach
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="floor" class="col-form-label-sm float-right">Tầng</label>
                                </div>
                                <div class="col-10">
                                    <select name="" id="floor" class="form-control form-control-sm custom-select">
                                        <option value="0">--- Chọn tầng ---</option>
                                        @foreach ($floors as $floor)
                                            <option value="{{ $floor->id }}"
                                                @if ($floor->id == $receipt->householdRoom->room->floor->id)
                                                    selected
                                                @endif>
                                                {{ $floor->number }}
                                            </option>
                                        @endforeach
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="room" class="col-form-label-sm float-right">Căn hộ</label>
                                </div>
                                <div class="col-10">
                                    <select name="" id="room" class="form-control form-control-sm custom-select">
                                        <option value="0">--- Chọn căn hộ ---</option>
                                        @foreach ($rooms as $room)
                                            <option value="{{ $room->id }}"
                                                @if ($room->id == $receipt->householdRoom->room->id)
                                                    selected
                                                @endif>
                                                {{ $room->name }}
                                            </option>
                                        @endforeach
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="customer_name" class="col-form-label-sm float-right">Tên khách hàng</label>
                                </div>
                                <div class="col-10">
                                    <input type="text" name="" id="customer_name" class="form-control form-control-sm" value="{{ $receipt->householdRoom->household->fullname }}" disabled>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="send_mail_to_customer" class="col-form-label-sm float-right">Gửi mail trực tiếp cho KH</label>
                                </div>
                                <div class="col-10 mt-1">
                                    <input type="checkbox" name="" id="send_mail_to_customer" value="1" style="cursor: pointer;" {{ $receipt->send_mail_to_customer == 0 ? '' : 'checked' }}>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="pay_method" class="col-form-label-sm float-right">Hình thức thanh toán</label>
                                </div>
                                <div class="col-10">
                                    <select name="" id="pay_method" class="form-control form-control-sm custom-select">
                                        <option value="0">--- Chọn hình thức thanh toán ---</option>
                                        <option value="tienmat" {{ $receipt->pay_method == 'Tiền mặt' ? 'selected' : '' }}>Tiền mặt</option>
                                        <option value="chuyenkhoan" {{ $receipt->pay_method == 'Chuyển khoản' ? 'selected' : '' }}>Chuyển khoản</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="bank_no" class="col-form-label-sm float-right">Số tài khoản</label>
                                </div>
                                <div class="col-10">
                                    <input type="text" name="" id="bank_no" class="form-control form-control-sm text-uppercase" value="{{ $receipt->bank_no }}">
                                </div>
                            </div>
                        </div>
                        <div class="form-group mb-2">
                            <div class="row">
                                <div class="col-2">
                                    <label for="bank_name" class="col-form-label-sm float-right">Tên ngân hàng</label>
                                </div>
                                <div class="col-10">
                                    <input type="text" name="" id="bank_name" class="form-control form-control-sm" value="{{ $receipt->bank_name }}">
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
        
                <div class="mt-2">
                    <button class="btn btn-warning btn-sm" id="refresh_row_btn">
                        <i class="fa-solid fa-rotate mr-1"></i>
                        Làm mới
                    </button>
                    <button class="btn btn-info btn-sm" id="add_row_btn">
                        <i class="fa-solid fa-plus mr-1"></i>
                        Thêm dòng
                    </button>
                </div>
                <div class="mt-2">
                    <table class="table table-hover table-dark table-striped m-0" id="receipt_table">
                        <thead>
                            <tr>
                                <th scope="col" style="width: 50px !important;">Xóa</th>
                                <th scope="col" style="width: 50px !important;">STT</th>
                                <th scope="col">Tên hàng hóa, dịch vụ</th>
                                <th scope="col" style="width: 120px !important;">Đơn vị tính</th>
                                <th scope="col" style="width: 120px !important;">Số lượng</th>
                                <th scope="col" style="width: 180px !important;">Đơn giá</th>
                                <th scope="col" style="width: 170px !important;">Thành tiền (VNĐ)</th>
                            </tr>
                        </thead>
                        <tbody id="receipt_table_data">
                            @php($i = 0)
                            @foreach ($products as $product)
                            @php($i++)
                            <input type="hidden" value="{{ $product->id }}" class="product_id">
                            <tr id="row_{{ $i }}">
                                <td scope="row">
                                    <button class="btn btn-outline-danger btn-sm remove_row" id="{{ $i }}">
                                        <i class="fa-solid fa-xmark"></i>
                                    </button>
                                </td>
                                <td scope="row"></td>
                                <td scope="row">
                                    <input type="text" class="form-control receipt_table_input product_name" value="{{ $product->name }}">
                                </td>
                                <td scope="row">
                                    <input type="text" class="form-control receipt_table_input product_unit" value="{{ $product->unit }}">
                                </td>
                                <td scope="row">
                                    <input type="number" class="form-control receipt_table_input product_quantity" value="{{ $product->quantity }}">
                                </td>
                                <td scope="row">
                                    <input type="number" class="form-control receipt_table_input product_price" value="{{ $product->price }}">
                                </td>
                                <td scope="row" class="product_total" style="line-height: 2;">{{ number_format($product->total, 0, ',', '.') }}</td>
                            </tr>
                            @endforeach
                        </tbody>
                    </table>
                </div>
                <div class="mt-2">
                    <form action="" method="" id="tax_form">
                        <div class="row">
                            <div class="col-4"></div>
                            <div class="col-4"></div>
                            <div class="col-4">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="total_before_tax" class="col-form-label-sm float-right">Tổng tiền trước thuế</label>
                                    </div>
                                    <div class="col-6">
                                        <p id="total_before_tax" class="text-danger tax_form_p mt-1">{{ $paidAmountAfterCal != null ? number_format($paidAmountAfterCal->total_before_tax, 0, ',', '.') : 0 }}</p>
                                    </div> 
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4"></div>
                            <div class="col-4">
                                <div class="row">
                                    <div class="col-5">
                                        <label for="vat_tax" class="col-form-label-sm float-right">Thuế GTGT</label>
                                    </div>
                                    <div class="col-7">
                                        <select name="" id="vat_tax" class="form-control form-control-sm custom-select">
                                            <option value="0" {{ $paidAmountAfterCal != null && $paidAmountAfterCal->vat_tax == 0 ? 'selected' : '' }}>0%</option>
                                            <option value="5" {{ $paidAmountAfterCal != null && $paidAmountAfterCal->vat_tax == 5 ? 'selected' : '' }}>5%</option>
                                            <option value="10" {{ $paidAmountAfterCal != null && $paidAmountAfterCal->vat_tax == 10 ? 'selected' : '' }}>10%</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="total_tax" class="col-form-label-sm float-right">Tổng tiền thuế</label>
                                    </div>
                                    <div class="col-6">
                                        <p id="total_tax" class="text-danger tax_form_p mt-1">{{ $paidAmountAfterCal != null ? number_format($paidAmountAfterCal->total_tax, 0, ',', '.') : 0 }}</p>
                                    </div> 
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                            </div>
                            <div class="col-4">
                            </div>
                            <div class="col-4">
                                <div class="row">
                                    <div class="col-6">
                                        <label for="total_after_tax" class="col-form-label-sm float-right">Tổng tiền sau thuế</label>
                                    </div>
                                    <div class="col-6">
                                        <p id="total_after_tax" class="text-danger tax_form_p mt-1">{{ $paidAmountAfterCal != null ? number_format($paidAmountAfterCal->total_after_tax, 0, ',', '.') : 0 }}</p>
                                    </div> 
                                </div>
                            </div>
                        </div>
                        {{-- <div class="row">
                            <div class="col-2">
                                <label for="total_in_words" class="col-form-label-sm ml-5">Số tiền bằng chữ</label>
                            </div>
                            <div class="col-10">
                                <input type="text" name="" id="total_in_words" class="form-control form-control-sm">
                            </div>
                        </div> --}}
                    </form>
                </div>
        
                <div class="mt-2">
                    <div class="d-flex justify-content-end">
                        <button class="btn btn-outline-secondary btn-sm mr-1" id="go_back_btn">
                            <i class="fa-solid fa-angles-left"></i>
                            Quay lại
                        </button>
                        <button class="btn btn-success btn-sm" id="update_data_btn">
                            <i class="fa-solid fa-check mr-1"></i>
                            Cập nhật
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
@endsection

@section('script')
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script>
        $(document).ready(function() {
            function resetInputReceiptForm() {
                $('#receipt_form').find(':input').val('');
                $('#receipt_form').find(':input(:checkbox)').prop('checked', false);
                $('#receipt_form').find('select').val('0');
                $('#form_no').val('1c21tnh');
            }

            function resetInputTaxForm() {
                $('#tax_form').find('.tax_form_p').text('0');
                $('#tax_form').find('select').val('0');
            }

            function resetProductTable() {
                // $('#receipt_table_data').remove();
                $('#receipt_table_data tr').each(function() {
                    $(this).remove();
                });
            }

            $('#apartment').change(function() {
                $('#customer_name').val('');
                let apartmentId = $(this).val();
                $.ajax({
                    type: "GET",
                    url: "{{ route('get.block.from.apartment.receipt') }}",
                    data: {
                        apartmentId: apartmentId,
                    },
                    success: function (res) {
                        if(res.status == 200) {
                            $('#block').html('<option value="0">--- Chọn nhà ---</option>');
                            $('#floor').html('<option value="0">--- Chọn tầng ---</option>');
                            $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                            $.each(res.blocks, function(key, value) {
                                $('#block').append('\
                                    <option value="'+ value.id +'">'+ value.name +'</option>\
                                ');
                            });
                        }
                    }
                });
            });

            $('#block').change(function() {
                $('#customer_name').val('');
                let blockId = $(this).val();
                $.ajax({
                    type: "GET",
                    url: "{{ route('get.floor.from.block.receipt') }}",
                    data: {
                        blockId: blockId,
                    },
                    success: function (res) {
                        if(res.status == 200) {
                            $('#floor').html('<option value="0">--- Chọn tầng ---</option>');
                            $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                            $.each(res.floors, function(key, value) {
                                $('#floor').append('\
                                    <option value="'+ value.id +'">'+ value.name +'</option>\
                                ');
                            });
                        }
                    }
                });
            });

            $('#floor').change(function() {
                $('#customer_name').val('');
                let floorId = $(this).val();
                $.ajax({
                    type: "GET",
                    url: "{{ route('get.room.from.floor.receipt') }}",
                    data: {
                        floorId: floorId,
                    },
                    success: function (res) {
                        if(res.status == 200) {
                            $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                            $.each(res.rooms, function(key, value) {
                                $('#room').append('\
                                    <option value="'+ value.id +'">'+ value.name +'</option>\
                                ');
                            });
                        }
                    }
                });
            });

            $('#room').change(function() {
                let roomId = $(this).val();
                if(roomId == 0) {
                    $('#customer_name').val('');
                    return;
                }
                $.ajax({
                    type: "GET",
                    url: "{{ route('get.household.from.room.receipt') }}",
                    data: {
                        roomId: roomId,
                    },
                    success: function (res) {
                        if(res.status == 200) {
                            $('#customer_name').val(res.household[0].fullname);
                            if($('#customer_name').val() != '') {
                                $('#customer_name').removeClass('border border-danger');
                                $('#customer_name + .text-danger').remove();
                            }                            
                        }

                        if(res.status == 400) {
                            alert(res.message);
                            $('#customer_name').val('');
                        }
                    }
                });
            });

            $('#refresh_input_receipt_form_btn').click(function(e) {
                e.preventDefault();
                resetInputReceiptForm();
            });

            $('#refresh_row_btn').click(function(e) {
                e.preventDefault();
                resetProductTable();
                resetInputTaxForm()
            });

            let index = 0;
            $('#add_row_btn').click(function(e) {
                e.preventDefault();

                index++;
                $('#receipt_table_data').append('\
                    <tr id="row_'+ index +'">\
                        <td scope="row">\
                            <button class="btn btn-outline-danger btn-sm remove_row" id="'+ index +'">\
                                <i class="fa-solid fa-xmark"></i>\
                            </button>\
                        </td>\
                        <td scope="row"></td>\
                        <td scope="row">\
                            <input type="text" class="form-control receipt_table_input product_name">\
                        </td>\
                        <td scope="row">\
                            <input type="text" class="form-control receipt_table_input product_unit">\
                        </td>\
                        <td scope="row">\
                            <input type="number" class="form-control receipt_table_input product_quantity">\
                        </td>\
                        <td scope="row">\
                            <input type="number" class="form-control receipt_table_input product_price">\
                        </td>\
                        <td scope="row" class="product_total" style="line-height: 2;"></td>\
                    </tr>\
                ');
            });

            $(document).on('click', '.remove_row', function(e) {
                e.preventDefault();
                let rowId = $(this).attr('id');
                $('#row_' + rowId).remove();
                recalculateTotalBeforeTax();
                if($('#receipt_table_data tr').length == 0)
                    $('#vat_tax').val('0');
            });

            function recalculateTotalBeforeTax() {
                let sum = 0;
                $('#receipt_table_data tr').each(function() {
                    if($(this).find('.product_quantity').val() != '' && $(this).find('.product_price').val() != '') {
                        let productQuantity = $(this).find('.product_quantity');
                        let productPrice = $(this).find('.product_price');
                        let productTotal = $(this).find('.product_total');
                        let result = parseFloat(productQuantity.val()) * parseFloat(productPrice.val());
                        productTotal.text(new Intl.NumberFormat('vi-VN').format(result));
                        sum += +parseFloat(productTotal.text().split('.').join(''));
                    }
                });
                $('#total_before_tax').text(new Intl.NumberFormat('vi-VN').format(sum));
                recalculateTax();
            }

            function recalculateTax() {
                let totalBeforeTax = $('#total_before_tax').text().split('.').join('');
                let totalTax = parseFloat(totalBeforeTax) * parseFloat($('#vat_tax').val()) / 100;
                $('#total_tax').text(new Intl.NumberFormat('vi-VN').format(totalTax));
                let totalAfterTax = parseFloat(totalBeforeTax) + parseFloat(totalTax);
                $('#total_after_tax').text(new Intl.NumberFormat('vi-VN').format(totalAfterTax));
            }
            
            $(document).on('input', '.product_quantity, .product_price', function() {
                recalculateTotalBeforeTax();
                $('#vat_tax').val('0');
                $('#total_tax').text('0');
            });

            $('#vat_tax').change(function() {
                recalculateTax();
            });

            $('#update_data_btn').prop('disabled', false).click(function(e) {
                e.preventDefault();

                $(this).prop('disabled', true);
                let formNo = $('#form_no > option:selected');
                let serialNo = $('#serial_no');
                let receiptNo = $('#receipt_no');
                let apartment = $('#apartment');
                let block = $('#block');
                let floor = $('#floor');
                let room = $('#room');
                let customerName = $('#customer_name');
                let bankNo = $('#bank_no');
                let bankName = $('#bank_name');
                let sendMailToCustomer = $('#send_mail_to_customer');
                let payMethod = $('#pay_method > option:selected');

                let receiptId = $('#receipt_id').val();
                let url = "{{ route('update.receipt', ':id') }}";
                url = url.replace(':id', receiptId);

                let productIdArr = [];
                $('.product_id').each(function() {
                    productIdArr.push($(this).val());
                });

                let productArr = [];
                $('#receipt_table_data tr').each(function() {
                    let products = [];
                    let productName = $(this).find('.product_name');
                    let productUnit = $(this).find('.product_unit');
                    let productQuantity = $(this).find('.product_quantity');
                    let productPrice = $(this).find('.product_price');
                    let productTotal = $(this).find('.product_total');
                    products.push(productName.val(), productUnit.val(), productQuantity.val(), productPrice.val(), productTotal.text());
                    productArr.push(products);
                });

                let totalBeforeTax = $('#total_before_tax');
                let vatTax = $('#vat_tax');
                let totalTax = $('#total_tax');
                let totalAfterTax = $('#total_after_tax');

                if(serialNo.val() == '' || receiptNo.val() == '' ||
                    customerName.val() == '' || $('#pay_method').val() == 0) 
                {
                    if(serialNo.val() == '') {
                        // alert('Không có hộ dân ở căn hộ này');
                        if(!serialNo.hasClass('border border-danger')) {
                            serialNo.addClass('border border-danger');
                            serialNo.after('<small class="text-danger">Vui lòng nhập ký hiệu cho Hóa đơn</small>');
                            serialNo.on('input', function() {
                                if(serialNo.val() != '') {
                                    $(this).removeClass('border border-danger');
                                    $('#serial_no + .text-danger').remove();
                                }
                            });
                        }
                    }
                    if(receiptNo.val() == '') {
                        // alert('Không có hộ dân ở căn hộ này');
                        if(!receiptNo.hasClass('border border-danger')) {
                            receiptNo.addClass('border border-danger');
                            receiptNo.after('<small class="text-danger">Vui lòng nhập số Hóa đơn</small>');
                            receiptNo.on('input', function() {
                                if(receiptNo.val() != '') {
                                    $(this).removeClass('border border-danger');
                                    $('#receipt_no + .text-danger').remove();
                                }
                            });
                        }
                    }
                    if(customerName.val() == '') {
                        // alert('Không có hộ dân ở căn hộ này');
                        if(!customerName.hasClass('border border-danger')) {
                            customerName.addClass('border border-danger');
                            customerName.after('<small class="text-danger">Vui lòng chọn hộ dân</small>');
                            // customerName.on('change', function() {
                            //     if(customerName.val() != '') {
                            //         $(this).removeClass('border border-danger');
                            //         $('#customer_name + .text-danger').remove();
                            //     }
                            // });
                        }
                    }
                    if($('#pay_method').val() == 0) {
                        // alert('Vui lòng chọn hình thức thanh toán');
                        if(!$('#pay_method').hasClass('border border-danger')) {
                            $('#pay_method').addClass('border border-danger');
                            $('#pay_method').after('<small class="text-danger">Vui lòng chọn hình thức thanh toán</small>');
                            $('#pay_method').change(function() {
                                $(this).removeClass('border border-danger');
                                $('#pay_method + .text-danger').remove();
                            });
                        }
                    }
                    $('#update_data_btn').prop('disabled', false);
                    return;
                }

                if($('#pay_method').val() == 'chuyenkhoan') {
                    if(bankNo.val() == '' || bankName.val() == '') {
                        if(bankNo.val() == '') {
                            if(!bankNo.hasClass('border border-danger')) {
                                bankNo.addClass('border border-danger');
                                bankNo.after('<small class="text-danger">Vui lòng nhập số tài khoản</small>');
                                bankNo.on('input', function() {
                                    if(bankNo.val() != '') {
                                        $(this).removeClass('border border-danger');
                                        $('#bank_no + .text-danger').remove();
                                    }
                                });
                            }
                        }
                        if(bankName.val() == '') {
                            if(!bankName.hasClass('border border-danger')) {
                                bankName.addClass('border border-danger');
                                bankName.after('<small class="text-danger">Vui lòng nhập nhập tên ngân hàng</small>');
                                bankName.on('input', function() {
                                    if(bankName.val() != '') {
                                        $(this).removeClass('border border-danger');
                                        $('#bank_name + .text-danger').remove();
                                    }
                                });
                            }
                        }
                        $('#update_data_btn').prop('disabled', false);
                        return;
                    }
                }
                $('#pay_method').change(function() {
                    if($('#pay_method').val() == 'tienmat') {
                        bankNo.val('');
                        bankNo.removeClass('border border-danger');
                        $('#bank_no + .text-danger').remove();

                        bankName.val('');
                        bankName.removeClass('border border-danger');
                        $('#bank_name + .text-danger').remove();
                    }
                });

                $.ajax({
                    type: "PATCH",
                    url: url,
                    data: {
                        receiptId: receiptId,
                        formNo: formNo.text(),
                        serialNo: serialNo.val(),
                        receiptNo: receiptNo.val(),
                        apartment: apartment.val(),
                        block: block.val(),
                        floor: floor.val(),
                        room: room.val(),
                        customerName: customerName.val(),
                        bankNo: bankNo.val(),
                        bankName: bankName.val(),
                        sendMailToCustomer: sendMailToCustomer.is(':checked') ? sendMailToCustomer.val() : '0',
                        payMethod: payMethod.text(),
                        productIdArr: productIdArr,
                        productArr: productArr,
                        totalBeforeTax: totalBeforeTax.text().split('.').join(''),
                        vatTax: vatTax.val(),
                        totalTax: totalTax.text().split('.').join(''),
                        totalAfterTax: totalAfterTax.text().split('.').join(''),
                        _token: "{{ csrf_token() }}",
                    },
                    success: function (res) {
                        if(res.status == 200) {
                            // $('#success_message').addClass('alert alert-success');
                            // $('#success_message').text(res.message);
                            $('#list_receipt_btn')[0].click();
                            $('#update_data_btn').prop('disabled', false);
                            alert(res.message);
                        }
                        if(res.status == 400) {
                            alert(res.message);
                            $('#update_data_btn').prop('disabled', false);
                            if(!receiptNo.hasClass('border border-danger')) { 
                                receiptNo.addClass('border border-danger');
                                receiptNo.after('<small class="text-danger">'+ res.message +'</small>');
                            }
                        }
                    }
                });
            });

            $('#go_back_btn').click(function(e) {
                e.preventDefault();
                history.back();
            });
        });
    </script>
@endsection
