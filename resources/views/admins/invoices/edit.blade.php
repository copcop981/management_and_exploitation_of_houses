@extends('admins.layouts.master')

@section('title')
    Chỉnh sửa biên lai
@endsection

@section('style')
    <style>
        /* #invoice_table {
            counter-reset: serial-number !important;
        }

        #invoice_table td:nth-child(2)::before {
            counter-increment: serial-number !important;
            content: counter(serial-number) !important;
        }

        .invoice_table_input {
            width: 100% !important;
            line-height: 1 !important;
            background-color: transparent !important;
            color: #fff !important;
        }

        .custom-select {
            padding-top: 2px;
        } */
    </style>
@endsection

@section('content')
<!--# Page header -->
<div class="page-header page-header-light">
    <div class="page-header-content header-elements-lg-inline">
        <div class="page-title d-flex"></div>
        <div class="header-elements d-none">
            <div class="d-flex justify-content-center">
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
            </div>
        </div>
    </div>
    <div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
        <div class="d-flex">
            <div class="breadcrumb">
                <a href="index.html" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
                <a href="alpaca_advanced.html" class="breadcrumb-item">Biên lai</a>
                <!-- <span class="breadcrumb-item active">Trang 1</span> -->
            </div>
            <a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
        </div>

    </div>
</div>
<!--# /page header -->

<div class="content">
    <div class="card mb-4 pt-3">
        <div class="container mb-2">
            <h5 class="text-uppercase">Chỉnh sửa biên lai</h5>
            <input type="hidden" value="{{ $invoice->id }}" id="invoice_id">

            <div class="mt-2">
                <div class="row">
                    <div class="col-2"></div>
                    <div class="col-10">
                        <div id="success_message" class="m-0">
    
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-2">
                <div class="row mb-2">
                    <div class="col-2">
                        <a href="{{ url('/admins/invoice') }}" class="btn btn-outline-success btn-sm" id="list_invoice_btn">
                            <i class="fa-solid fa-angles-left mr-1"></i>
                            Danh sách BL
                        </a>
                    </div>
                    <div class="col-10">
                        <button class="btn btn-warning btn-sm" id="refresh_input_invoice_form_btn">
                            <i class="fa-solid fa-rotate mr-1"></i>
                            Làm mới
                        </button>
                    </div>
                </div>
                <form action="" method="" id="invoice_form">
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="form_no" class="col-form-label-sm float-right">Mẫu số</label>
                            </div>
                            <div class="col-10">
                                <div class="row">
                                    <div class="col-4">
                                        <select name="" id="form_no" class="form-control form-control-sm custom-select">
                                            <option value="1c21tnh" {{ $invoice->form_no == '1C21TNHH' ? 'selected' : '' }}>1C21TNH</option>
                                        </select>
                                    </div>
                                    <div class="col-1">
                                        <label for="serial_no" class="col-form-label-sm float-right">Ký hiệu</label>
                                    </div>
                                    <div class="col-3">
                                        <input type="text" name="" id="serial_no" class="form-control form-control-sm text-uppercase" value="{{ $invoice->serial_no }}">
                                    </div>
                                    <div class="col-1">
                                        <label for="invoice_no" class="col-form-label-sm float-right">Số BL</label>
                                    </div>
                                    <div class="col-3">
                                        <input type="number" name="" id="invoice_no" class="form-control form-control-sm" value="{{ $invoice->invoice_no }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="apartment" class="col-form-label-sm float-right">Tên chung cư</label>
                            </div>
                            <div class="col-10">
                                <select name="" id="apartment" class="form-control form-control-sm custom-select">
                                    <option value="0">--- Chọn chung cư ---</option>
                                    @foreach ($apartments as $apartment)
                                        <option value="{{ $apartment->id }}" 
                                            @if($apartment->id == $invoice->householdRoom->room->floor->block->apartment->id)
                                                selected
                                            @endif>
                                            {{ $apartment->name }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="block" class="col-form-label-sm float-right">Nhà</label>
                            </div>
                            <div class="col-10">
                                <select name="" id="block" class="form-control form-control-sm custom-select">
                                    <option value="0">--- Chọn nhà ---</option>
                                    @foreach ($blocks as $block)
                                        <option value="{{ $block->id }}"
                                            @if ($block->id == $invoice->householdRoom->room->floor->block->id)
                                                selected
                                            @endif>
                                            {{ $block->name }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="floor" class="col-form-label-sm float-right">Tầng</label>
                            </div>
                            <div class="col-10">
                                <select name="" id="floor" class="form-control form-control-sm custom-select">
                                    <option value="0">--- Chọn tầng ---</option>
                                    @foreach ($floors as $floor)
                                        <option value="{{ $floor->id }}"
                                            @if ($floor->id == $invoice->householdRoom->room->floor->id)
                                                selected
                                            @endif>
                                            {{ $floor->number }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="room" class="col-form-label-sm float-right">Căn hộ</label>
                            </div>
                            <div class="col-10">
                                <select name="" id="room" class="form-control form-control-sm custom-select">
                                    <option value="0">--- Chọn căn hộ ---</option>
                                    @foreach ($rooms as $room)
                                        <option value="{{ $room->id }}"
                                            @if ($room->id == $invoice->householdRoom->room->id)
                                                selected
                                            @endif>
                                            {{ $room->name }}
                                        </option>
                                    @endforeach
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="customer_name" class="col-form-label-sm float-right">Tên khách hàng</label>
                            </div>
                            <div class="col-10">
                                <input type="text" name="" id="customer_name" class="form-control form-control-sm" value="{{ $invoice->householdRoom->household->fullname }}" disabled>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="fee_name" class="col-form-label-sm float-right">Tên loại phí, lệ phí</label>
                            </div>
                            <div class="col-10">
                                <textarea name="" id="fee_name" class="form-control" rows="2">{{ $invoice->fee_name }}</textarea>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="fee_amount" class="col-form-label-sm float-right">Số tiền nộp</label>
                            </div>
                            <div class="col-10">
                                <input type="number" name="" id="fee_amount" class="form-control form-control-sm" value="{{ $invoice->fee_amount }}">
                            </div>
                        </div>
                    </div>
                    {{-- <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="send_mail_to_customer" class="col-form-label-sm float-right">Gửi mail trực tiếp cho KH</label>
                            </div>
                            <div class="col-10 mt-1">
                                <input type="checkbox" name="" id="send_mail_to_customer" value="1" style="cursor: pointer;" {{ $invoice->send_mail_to_customer == 0 ? '' : 'checked' }}>
                            </div>
                        </div>
                    </div> --}}
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="pay_method" class="col-form-label-sm float-right">Hình thức thanh toán</label>
                            </div>
                            <div class="col-10">
                                <select name="" id="pay_method" class="form-control form-control-sm custom-select">
                                    <option value="0">--- Chọn hình thức thanh toán ---</option>
                                    <option value="tienmat" {{ $invoice->pay_method == 'Tiền mặt' ? 'selected' : '' }}>Tiền mặt</option>
                                    <option value="chuyenkhoan" {{ $invoice->pay_method == 'Chuyển khoản' ? 'selected' : '' }}>Chuyển khoản</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="bank_no" class="col-form-label-sm float-right">Số tài khoản</label>
                            </div>
                            <div class="col-10">
                                <input type="text" name="" id="bank_no" class="form-control form-control-sm text-uppercase" value="{{ $invoice->bank_no }}">
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-2">
                        <div class="row">
                            <div class="col-2">
                                <label for="bank_name" class="col-form-label-sm float-right">Tên ngân hàng</label>
                            </div>
                            <div class="col-10">
                                <input type="text" name="" id="bank_name" class="form-control form-control-sm" value="{{ $invoice->bank_name }}">
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="mt-2">
                <div class="d-flex justify-content-end">
                    <button class="btn btn-outline-secondary btn-sm mr-1" id="go_back_btn">
                        <i class="fa-solid fa-angles-left"></i>
                        Quay lại
                    </button>
                    <button class="btn btn-success btn-sm" id="update_data_btn">
                        <i class="fa-solid fa-check mr-1"></i>
                        Cập nhật
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('script')
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        function resetInputInvoiceForm() {
            $('#invoice_form').find(':input').val('');
            $('#invoice_form').find(':input(:checkbox)').prop('checked', false);
            $('#invoice_form').find('select').val('0');
            $('#form_no').val('1c21tnh');
        }

        $('#apartment').change(function() {
            $('#customer_name').val('');
            let apartmentId = $(this).val();
            $.ajax({
                type: "GET",
                url: "{{ route('get.block.from.apartment.invoice') }}",
                data: {
                    apartmentId: apartmentId,
                },
                success: function (res) {
                    if(res.status == 200) {
                        $('#block').html('<option value="0">--- Chọn nhà ---</option>');
                        $('#floor').html('<option value="0">--- Chọn tầng ---</option>');
                        $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                        $.each(res.blocks, function(key, value) {
                            $('#block').append('\
                                <option value="'+ value.id +'">'+ value.name +'</option>\
                            ');
                        });
                    }
                }
            });
        });

        $('#block').change(function() {
            $('#customer_name').val('');
            let blockId = $(this).val();
            $.ajax({
                type: "GET",
                url: "{{ route('get.floor.from.block.invoice') }}",
                data: {
                    blockId: blockId,
                },
                success: function (res) {
                    if(res.status == 200) {
                        $('#floor').html('<option value="0">--- Chọn tầng ---</option>');
                        $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                        $.each(res.floors, function(key, value) {
                            $('#floor').append('\
                                <option value="'+ value.id +'">'+ value.name +'</option>\
                            ');
                        });
                    }
                }
            });
        });

        $('#floor').change(function() {
            $('#customer_name').val('');
            let floorId = $(this).val();
            $.ajax({
                type: "GET",
                url: "{{ route('get.room.from.floor.invoice') }}",
                data: {
                    floorId: floorId,
                },
                success: function (res) {
                    if(res.status == 200) {
                        $('#room').html('<option value="0">--- Chọn căn hộ ---</option>');
                        $.each(res.rooms, function(key, value) {
                            $('#room').append('\
                                <option value="'+ value.id +'">'+ value.name +'</option>\
                            ');
                        });
                    }
                }
            });
        });

        $('#room').change(function() {
            let roomId = $(this).val();
            if(roomId == 0) {
                $('#customer_name').val('');
                return;
            }
            $.ajax({
                type: "GET",
                url: "{{ route('get.household.from.room.invoice') }}",
                data: {
                    roomId: roomId,
                },
                success: function (res) {
                    if(res.status == 200) {
                        $('#customer_name').val(res.household[0].fullname);
                        if($('#customer_name').val() != '') {
                            $('#customer_name').removeClass('border border-danger');
                            $('#customer_name + .text-danger').remove();
                        }                            
                    }

                    if(res.status == 400) {
                        alert(res.message);
                        $('#customer_name').val('');
                    }
                }
            });
        });

        $('#refresh_input_invoice_form_btn').click(function(e) {
            e.preventDefault();
            resetInputInvoiceForm();
        });

        $('#update_data_btn').prop('disabled', false).click(function(e) {
            e.preventDefault();

            $(this).prop('disabled', true);
            let formNo = $('#form_no > option:selected');
            let serialNo = $('#serial_no');
            let invoiceNo = $('#invoice_no');
            let apartment = $('#apartment');
            let block = $('#block');
            let floor = $('#floor');
            let room = $('#room');
            let customerName = $('#customer_name');
            let feeName = $('#fee_name');
            let feeAmount = $('#fee_amount');
            let bankNo = $('#bank_no');
            let bankName = $('#bank_name');
            let payMethod = $('#pay_method > option:selected');

            let invoiceId = $('#invoice_id').val();
            let url = "{{ route('update.invoice', ':id') }}";
            url = url.replace(':id', invoiceId);

            if(feeName.val() == '' || feeAmount.val() == '' || 
                serialNo.val() == '' || invoiceNo.val() == '' || 
                customerName.val() == '' || $('#pay_method').val() == 0) 
            {
                if(feeName.val() == '') {
                    if(!feeName.hasClass('border border-danger')) {
                        feeName.addClass('border border-danger');
                        feeName.after('<small class="text-danger">Vui lòng nhập nội dung</small>');
                        feeName.on('input', function() {
                            if(feeName.val() != '') {
                                $(this).removeClass('border border-danger');
                                $('#fee_name + .text-danger').remove();
                            }
                        });
                    }
                }
                if(feeAmount.val() == '') {
                    if(!feeAmount.hasClass('border border-danger')) {
                        feeAmount.addClass('border border-danger');
                        feeAmount.after('<small class="text-danger">Vui lòng nhập số tiền</small>');
                        feeAmount.on('input', function() {
                            if(feeAmount.val() != '') {
                                $(this).removeClass('border border-danger');
                                $('#fee_amount + .text-danger').remove();
                            }
                        });
                    }
                }
                if(serialNo.val() == '') {
                    if(!serialNo.hasClass('border border-danger')) {
                        serialNo.addClass('border border-danger');
                        serialNo.after('<small class="text-danger">Vui lòng nhập ký hiệu</small>');
                        serialNo.on('input', function() {
                            if(serialNo.val() != '') {
                                $(this).removeClass('border border-danger');
                                $('#serial_no + .text-danger').remove();
                            }
                        });
                    }
                }
                if(invoiceNo.val() == '') {
                    if(!invoiceNo.hasClass('border border-danger')) {
                        invoiceNo.addClass('border border-danger');
                        invoiceNo.after('<small class="text-danger">Vui lòng nhập số Biên lai</small>');
                        invoiceNo.on('input', function() {
                            if(invoiceNo.val() != '') {
                                $(this).removeClass('border border-danger');
                                $('#invoice_no + .text-danger').remove();
                            }
                        });
                    }
                }
                if(customerName.val() == '') {
                    // alert('Không có hộ dân ở căn hộ này');
                    if(!customerName.hasClass('border border-danger')) {
                        customerName.addClass('border border-danger');
                        customerName.after('<small class="text-danger">Vui lòng chọn hộ dân</small>');
                        // customerName.on('change', function() {
                        //     if(customerName.val() != '') {
                        //         $(this).removeClass('border border-danger');
                        //         $('#customer_name + .text-danger').remove();
                        //     }
                        // });
                    }
                }
                if($('#pay_method').val() == 0) {
                    // alert('Vui lòng chọn hình thức thanh toán');
                    if(!$('#pay_method').hasClass('border border-danger')) {
                        $('#pay_method').addClass('border border-danger');
                        $('#pay_method').after('<small class="text-danger">Vui lòng chọn hình thức thanh toán</small>');
                        $('#pay_method').change(function() {
                            $(this).removeClass('border border-danger');
                            $('#pay_method + .text-danger').remove();
                        });
                    }
                }
                $('#update_data_btn').prop('disabled', false);
                return;
            }

            if($('#pay_method').val() == 'chuyenkhoan') {
                if(bankNo.val() == '' || bankName.val() == '') {
                    if(bankNo.val() == '') {
                        if(!bankNo.hasClass('border border-danger')) {
                            bankNo.addClass('border border-danger');
                            bankNo.after('<small class="text-danger">Vui lòng nhập số tài khoản</small>');
                            bankNo.on('input', function() {
                                if(bankNo.val() != '') {
                                    $(this).removeClass('border border-danger');
                                    $('#bank_no + .text-danger').remove();
                                }
                            });
                        }
                    }
                    if(bankName.val() == '') {
                        if(!bankName.hasClass('border border-danger')) {
                            bankName.addClass('border border-danger');
                            bankName.after('<small class="text-danger">Vui lòng nhập nhập tên ngân hàng</small>');
                            bankName.on('input', function() {
                                if(bankName.val() != '') {
                                    $(this).removeClass('border border-danger');
                                    $('#bank_name + .text-danger').remove();
                                }
                            });
                        }
                    }
                    $('#update_data_btn').prop('disabled', false);
                    return;
                }
            } 
            $('#pay_method').change(function() {
                if($('#pay_method').val() == 'tienmat') {
                    bankNo.val('');
                    bankNo.removeClass('border border-danger');
                    $('#bank_no + .text-danger').remove();

                    bankName.val('');
                    bankName.removeClass('border border-danger');
                    $('#bank_name + .text-danger').remove();
                }
            });

            $.ajax({
                type: "PATCH",
                url: url,
                data: {
                    invoiceId: invoiceId,
                    formNo: formNo.text(),
                    serialNo: serialNo.val(),
                    invoiceNo: invoiceNo.val(),
                    apartment: apartment.val(),
                    block: block.val(),
                    floor: floor.val(),
                    room: room.val(),
                    customerName: customerName.val(),
                    feeName: feeName.val(),
                    feeAmount: feeAmount.val(),
                    bankNo: bankNo.val(),
                    bankName: bankName.val(),
                    payMethod: payMethod.text(),
                    _token: "{{ csrf_token() }}",
                },
                success: function (res) {
                    if(res.status == 200) {
                        // $('#success_message').addClass('alert alert-success');
                        // $('#success_message').text(res.message);
                        $('#list_invoice_btn')[0].click();
                        $('#update_data_btn').prop('disabled', false);
                        alert(res.message);
                    }
                    if(res.status == 400) {
                        alert(res.message);
                        $('#update_data_btn').prop('disabled', false);
                        if(!invoiceNo.hasClass('border border-danger')) { 
                            invoiceNo.addClass('border border-danger');
                            invoiceNo.after('<small class="text-danger">'+ res.message +'</small>');
                        }
                    }
                }
            });
        });

        $('#go_back_btn').click(function(e) {
            e.preventDefault();
            history.back();
        });
    });
</script>
@endsection
