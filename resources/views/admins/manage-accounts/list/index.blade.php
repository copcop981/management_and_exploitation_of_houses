@extends('admins.layouts.master')

@section('title') 
    Danh sách tài khoản
@endsection

@section('style')
<style>
    fieldset.scheduler-border {
        border: 1px groove #ddd !important;
        padding: 0 1.4em .2em 1.4em !important;
        margin: 0 !important;
        -webkit-box-shadow: 0px 0px 0px 0px #000;
                box-shadow: 0px 0px 0px 0px #000;
    }

    legend.scheduler-border {
        /* font-size: 1.2em !important; */
        /* font-weight: bold !important; */
        /* text-align: left !important; */
        width: auto;
        padding: 0 10px;
        border-bottom: none;
    }

    table {
        min-width: max-content;
    }


    th {
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.4);
        background: #333;
        position: sticky;
        top: 0;
        z-index: 999;
    }

    .table-wrapper {
        max-height: 450px;
        overflow: scroll;
    }
</style>
@endsection

@section('content')
<!--# Page header -->
<div class="page-header page-header-light">
    <div class="page-header-content header-elements-lg-inline">
        <div class="page-title d-flex"></div>
        <div class="header-elements d-none">
            <div class="d-flex justify-content-center">
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-bars-alt text-primary"></i><span>Thống kê</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calculator text-primary"></i> <span>Hóa đơn</span></a>
                <a href="#" class="btn btn-link btn-float text-body"><i class="icon-calendar5 text-primary"></i> <span>Lịch trình</span></a>
            </div>
        </div>
    </div>
    <div class="breadcrumb-line breadcrumb-line-light header-elements-lg-inline">
        <div class="d-flex">
            <div class="breadcrumb">
                <a href="" class="breadcrumb-item"><i class="icon-home2 mr-2"></i> Trang chủ</a>
                <a href="" class="breadcrumb-item">Quản lí tài khoản</a>
                <span href="" class="breadcrumb-item active">Danh sách</span>
            </div>
            <a href="#" class="header-elements-toggle text-body d-lg-none"><i class="icon-more"></i></a>
        </div>

    </div>
</div>
<!--# /page header -->

<div class="content">
    <div class="card mb-4">
        <div class="container mb-2">
            <div class="mt-2">
                <fieldset class="scheduler-border">
                    <legend class="scheduler-border">Tìm kiếm</legend>
                    <form action="" method="" id="form_search">
                        <div class="form-group">
                            <div class="row align-items-center">
                                <div class="col-12" style="display: flex; position: relative;">
                                    <input type="text" name="input_search" id="input_search" class="form-control form-control-sm" placeholder="Họ tên, tên đăng nhập, hoặc email, sđt">
                                    <a href="" class="d-none" id="btn_refresh_input_search">
                                        <i class="fa-solid fa-xmark" style="position: absolute;
                                            top: 50%;
                                            transform: translateY(-50%);
                                            right: 2%;
                                            padding: 10px;
                                            font-size: 16px;
                                            cursor: pointer;
                                            color: #868686;">
                                        </i>
                                    </a>
                                </div>
                                {{-- <div class="col-2">
                                    <button type="button" class="btn btn-success btn-sm" id="btn_search">
                                        <i class="fa-solid fa-magnifying-glass mr-1"></i>
                                        Tìm kiếm
                                    </button>
                                    <button type="button" class="btn btn-warning btn-sm" id="btn_refresh_input_search">
                                        <i class="fa-solid fa-rotate mr-1"></i>
                                        Làm mới
                                    </button>
                                </div> --}}
                            </div>
                        </div>
                    </form>
                </fieldset>
            </div>

            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <div>
                        <select name="" id="row" class="form-control custom-select custom-select-sm">
                            <option value="5">5 hàng</option>
                            <option value="10">10 hàng</option>
                            <option value="15">15 hàng</option>
                            <option value="20">20 hàng</option>
                        </select>
                    </div>
                    <div>
                        <button type="button" class="btn btn-info btn-sm" id="btn_create">
                            <i class="fa-solid fa-plus mr-1"></i>
                            Tạo mới
                        </button>
                        {{-- <button type="button" class="btn btn-danger btn-sm" id="delete_many_apartment_btn" hidden>
                            <i class="fa-solid fa-trash mr-1"></i>
                            Xóa hàng loạt
                        </button> --}}
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <i class="fa-solid fa-paper-plane" style="color: #868686;"></i>
                <span class="text-uppercase" style="color: #868686; font-weight: 500;">Danh sách tài khoản</span>
            </div>

            <div id="list_account_table">
                @include('admins.manage-accounts.list.pagination')
            </div>

            {{-- Modal Tạo mới --}}
            <div class="modal fade" id="modal_create" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Tạo mới Tài khoản</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="" id="form_create">
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Họ tên:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="fullname_create">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Tên đăng nhập:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="username_create" maxlength="50">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Mật khẩu:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="password" class="form-control form-control-sm" id="password_create">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Email:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="email" class="form-control form-control-sm" id="email_create">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Số điện thoại:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="phone_number_create" maxlength="20">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-warning btn-sm" id="btn_refresh_store" style="margin-left: 0.5rem !important;">Làm mới</button>
                            <button type="button" class="btn btn-primary btn-sm" id="btn_store" style="margin-left: 0.5rem !important;">Lưu</button>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Modal Chỉnh sửa --}}
            <div class="modal fade" id="modal_edit" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Chỉnh sửa Tài khoản</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form action="" id="form_edit">
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Họ tên:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="fullname_edit">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Tên đăng nhập:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="username_edit" disabled>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Email:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="email" class="form-control form-control-sm" id="email_edit">
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-3">
                                        <label for="" class="col-form-label-sm float-right">Số điện thoại:</label>
                                    </div>
                                    <div class="col-9">
                                        <input type="text" class="form-control form-control-sm" id="phone_number_edit" maxlength="20">
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-warning btn-sm" id="btn_refresh_update" style="margin-left: 0.5rem !important;">Làm mới</button>
                            <button type="button" class="btn btn-success btn-sm" id="btn_update" style="margin-left: 0.5rem !important;">Cập nhật</button>
                        </div>
                    </div>
                </div>
            </div>

            {{-- Modal Xác nhận xóa --}}
            <div class="modal fade" id="modal_delete" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Xác nhận</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <span>Xác nhận xóa Tài khoản này?</span>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary btn-sm" data-dismiss="modal">Đóng</button>
                            <button type="button" class="btn btn-danger btn-sm" id="btn_destroy" style="margin-left: 0.5rem !important;">Xóa</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@endsection

@section('script')
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script>
    $(document).ready(function() {
        function validate(fullname, username, password, email, btn) {
            let validateFullname = validateField(fullname, btn, 'input', 'Vui lòng nhập Họ tên');
            let validateUsername = validateField(username, btn, 'input', 'Vui lòng nhập Tên đăng nhập');
            let validatePassword = validateField(password, btn, 'input', 'Vui lòng nhập Mật khẩu');
            let validateEmail = validateField(email, btn, 'input', 'Vui lòng nhập Email');
            if(!validateFullname || !validateUsername || !validatePassword || !validateEmail)
                return false;
            return true;
        }

        $(document).off('keypress', '#fullname_create, #fullname_edit').on('keypress', '#fullname_create, #fullname_edit', function(e) {
            var key = String.fromCharCode(!e.charCode ? e.which : e.charCode);
            if(preventSpecialCharNNumber(key)) e.preventDefault();
        });

        $(document).off('keypress', '#phone_number_create, #phone_number_edit').on('keypress', '#phone_number_create, #phone_number_edit', function(e) {
            var key = String.fromCharCode(!e.charCode ? e.which : e.charCode);
            if(validateSdtFormat(key)) e.preventDefault();
        });

        $(document).off('click', '#btn_create').on('click', '#btn_create', function(e) {
            e.preventDefault();
            $('#modal_create').modal('show');
            let fullname = $('#fullname_create');
            let username = $('#username_create');
            let password = $('#password_create');
            let email = $('#email_create');
            let phoneNumber = $('#phone_number_create');

            $(document).prop('disabled', false).off('click', '#btn_store').on('click', '#btn_store', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                if(!validate('#fullname_create', '#username_create', '#password_create', '#email_create', $(this))) return;
                if(!validatePwdLength(password.val(), '#password_create', $(this), 'Vui lòng nhập mật khẩu tối thiểu 6 ký tự')) return;
                if(!validateEmailFormat(email.val(), '#email_create', $(this), 'Email không đúng định dạng. Hãy thử lại')) return;
                if(preventSpecialCharNNumber(fullname.val())) {
                    alert('Họ tên không hợp lệ');
                    fullname.trigger('focus');
                    $(this).prop('disabled', false);
                    return;
                }
                if(phoneNumber.val() != '') {
                    if(validateSdtFormat(phoneNumber.val())) {
                        alert('Số điện thoại không hợp lệ');
                        phoneNumber.trigger('focus')
                        $(this).prop('disabled', false);
                        return;
                    }
                }
                $.ajax({
                    type: "POST",
                    url: "{{ route('manage-accounts.store') }}",
                    data: {
                        fullname: fullname.val(),
                        username: username.val(),
                        password: password.val(),
                        email: email.val(),
                        phoneNumber: phoneNumber.val() != '' ? phoneNumber.val() : '',
                        _token: "{{ csrf_token() }}",
                    },
                    success: function (res) {
                        if(res.status === 0) {
                            alert(res.message);
                            $('#btn_store').prop('disabled', false);
                            $('#modal_create').modal('hide');
                            $('#row').val('5').trigger('change');
                        }
                        if(res.status === 1) {
                            alert(res.message);
                            $('#btn_store').prop('disabled', false);
                        }
                    },
                    error: function(res) {
                        let message = res.responseJSON.message;
                        if(message.indexOf('SQLSTATE[23000]') !== -1 && message.indexOf('1062 Duplicate entry') !== -1 && message.indexOf('accounts_username_unique') !== -1) {
                            alert('Tên đăng nhập này đã tồn tại');
                            username.trigger('focus');
                            $('#btn_store').prop('disabled', false);
                        }''
                        if(message.indexOf('SQLSTATE[23000]') !== -1 && message.indexOf('1062 Duplicate entry') !== -1 && message.indexOf('accounts_email_unique') !== -1) {
                            alert('Email này đã được đăng ký');
                            email.trigger('focus');
                            $('#btn_store').prop('disabled', false);
                        }
                        if(message.indexOf('SQLSTATE[23000]') !== -1 && message.indexOf('1062 Duplicate entry') !== -1 && message.indexOf('accounts_phone_number_unique') !== -1) {
                            alert('Số điện thoại này đã được đăng ký');
                            phoneNumber.trigger('focus');
                            $('#btn_store').prop('disabled', false);
                        }
                    }
                });
            });

            $(document).off('click', '#btn_refresh_store').on('click', '#btn_refresh_store', function(e) {
                e.preventDefault();
                $('#form_create').find(':input').val('');
                removeValidateDanger('#form_create');
            });

            $(document).off('hidden.bs.modal', '#modal_create').on('hidden.bs.modal', '#modal_create', function() {
                $('#btn_refresh_store').click();
                removeValidateDanger('#form_create');
            });
        });

        $(document).off('click', '#btn_edit').on('click', '#btn_edit', function(e) {
            e.preventDefault();
            let id = $(this).val();
            let fullname = $('#fullname_edit');
            let username = $('#username_edit');
            let email = $('#email_edit');
            let phoneNumber = $('#phone_number_edit');
            $('#modal_edit').modal('show');

            $(document).off('shown.bs.modal', '#modal_edit').on('shown.bs.modal', '#modal_edit', function() {
                let url = "{{ route('manage-accounts.edit', ':id') }}";
                url = url.replace(':id', id);
                $.ajax({
                    type: "GET",
                    url: url,
                    success: function (res) {
                        if(res.account !== null) {
                            fullname.val(res.account.fullname);
                            username.val(res.account.username);
                            email.val(res.account.email);
                            phoneNumber.val(res.account.phone_number);
                        }
                    }
                });
            });

            $(document).prop('disabled', false).off('click', '#btn_update').on('click', '#btn_update', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                if(!validate('#fullname_edit', '#username_edit', '#password_edit', '#email_edit', $(this))) return;
                if(!validateEmailFormat(email.val(), '#email_edit', $(this), 'Email không đúng định dạng. Hãy thử lại')) return;
                if(preventSpecialCharNNumber(fullname.val())) {
                    alert('Họ tên không hợp lệ');
                    fullname.trigger('focus');
                    $(this).prop('disabled', false);
                    return;
                }
                if(phoneNumber.val() != '') {
                    if(validateSdtFormat(phoneNumber.val())) {
                        alert('Số điện thoại không hợp lệ');
                        phoneNumber.trigger('focus')
                        $(this).prop('disabled', false);
                        return;
                    }
                }
                let url = "{{ route('manage-accounts.update', ':id') }}";
                url = url.replace(':id', id);
                $.ajax({
                    type: "PATCH",
                    url: url,
                    data: {
                        fullname: fullname.val(),
                        email: email.val(),
                        phoneNumber: phoneNumber.val(),
                        _token: "{{ csrf_token() }}",
                    },
                    success: function (res) {
                        if(res.status === 0) {
                            alert(res.message);
                            $('#btn_update').prop('disabled', false);
                            $('#modal_edit').modal('hide');
                            $('#row').val('5').trigger('change');
                        }
                        if(res.status === 1) {
                            alert(res.message);
                            $('#btn_update').prop('disabled', false);
                        }
                    },
                    error: function(res) {
                        let message = res.responseJSON.message;
                        if(message.indexOf('SQLSTATE[23000]') !== -1 && message.indexOf('1062 Duplicate entry') !== -1 && message.indexOf('accounts_email_unique') !== -1) {
                            alert('Email này đã tồn tại');
                            $('#btn_update').prop('disabled', false);
                        }
                        if(message.indexOf('SQLSTATE[23000]') !== -1 && message.indexOf('1062 Duplicate entry') !== -1 && message.indexOf('accounts_phone_number_unique') !== -1) {
                            alert('Số điện thoại này đã tồn tại');
                            phoneNumber.trigger('focus');
                            $('#btn_update').prop('disabled', false);
                        }
                    }
                });
            });

            $(document).off('click', '#btn_refresh_update').on('click', '#btn_refresh_update', function(e) {
                e.preventDefault();
                $('#modal_edit').trigger('shown.bs.modal');
            });

            $(document).off('hidden.bs.modal', '#modal_edit').on('hidden.bs.modal', '#modal_edit', function() {
                $('#btn_refresh_update').click();
                removeValidateDanger('#form_edit');
            });
        });

        $(document).off('click', '#btn_delete').on('click', '#btn_delete', function(e) {
            e.preventDefault();
            $('#modal_delete').modal('show');
            let id = $(this).val();
            let url = "{{ route('manage-accounts.destroy', ':id') }}";
            url = url.replace(':id', id);

            $(document).prop('disabled', false).off('click', '#btn_destroy').on('click', '#btn_destroy', function(e) {
                e.preventDefault();
                $(this).prop('disabled', true);
                $.ajax({
                    type: "DELETE",
                    url: url,
                    data: { _token: "{{ csrf_token() }}", },
                    success: function (res) {
                        if(res.status === 0) {
                            alert(res.message);
                            $('#btn_destroy').prop('disabled', false);
                            $('#modal_delete').modal('hide');
                            $('#row').val('5').trigger('change');
                        }
                        if(res.status === 1) {
                            alert(res.message);
                            $('#btn_destroy').prop('disabled', false);
                        }
                    }
                });
            });
        });

        let search = $('#input_search');
        $(document).off('click', '#btn_refresh_input_search').on('click', '#btn_refresh_input_search', function(e) {
            e.preventDefault();
            search.val('');
            $(this).removeClass('d-inline');
            $(this).addClass('d-none');
            search.trigger('focus');
            $('#row').val('5').trigger('change');
        });

        $(document).off('input', '#input_search').on('input', '#input_search', function() {
            if($(this).val() != '') {
                $('#btn_refresh_input_search').removeClass('d-none');
                $('#btn_refresh_input_search').addClass('d-inline');
            } else {
                $('#btn_refresh_input_search').removeClass('d-inline');
                $('#btn_refresh_input_search').addClass('d-none');
                $('#row').val('5').trigger('change');
                return;
            }
            $.ajax({
                type: "GET",
                url: "{{ route('manage-accounts.search') }}",
                data: { search: search.val() },
                success: function (res) {
                    $('#btn_search').prop('disabled', false);
                    $('#list_account_table').html(res);
                    $('#row').val('15');
                }
            });
        });
        
        $(document).off('click', '.pagination a').on('click', '.pagination a', function(e) {
            e.preventDefault();
            let page = $(this).attr('href').split('?page=')[1];
            let numRow = $('#row').val();
            $.ajax({
                url: "/admins/manage-accounts/fetch?page=" + page,
                data: {
                    search: search.val(),
                    numRow: numRow > 0 ? numRow : 0,
                },
                success: function (res) {
                    $('#list_account_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });

        $(document).off('change', '#row').on('change', '#row', function() {
            if($(this).val() == '5') {
                search.val('');
                $('#btn_refresh_input_search').removeClass('d-inline');
                $('#btn_refresh_input_search').addClass('d-none');
            }
            let numRow = $(this).val();
            $.ajax({
                url: "{{ route('get.row.manage-accounts') }}",
                data: {
                    search: search.val(),
                    numRow: numRow,
                },
                success: function (res) {
                    $('#list_account_table').html(res);
                    $('#row').val(numRow);
                }
            });
        });
    });
</script>
@endsection
