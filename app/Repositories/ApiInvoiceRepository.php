<?php

namespace App\Repositories;

use Illuminate\Http\Request;
use App\Http\Requests\RequestResetPass;
use App\Models_12345\TicketObtained;
use Exception;
use SoapClient;

class ApiInvoiceRepository extends AbstractRepository
{
    public function getModel()
    {
        return TicketObtained::class;
    }

    public function publish($fkey, $cus_name, $prod_name, $vat, $total_vat, $total_before_vat, $total_price, $pattern, $serial) {
        $data = array();
        try {
            $soapClient = new SoapClient('https://ttquanlykhaithacnhadngadmindemo.vnpt-invoice.com.vn/PublishService.asmx?wsdl');
            $param = array(
                'Account' => 'ttquanlykhaithacnhadngadmin',
                'ACpass' => 'Einv@oi@vn#pt20',
                'xmlInvData' => '
                    <Invoices>
                        <Inv>
                            <key>'.$fkey.'</key>
                            <Invoice>
                                <CusCode>'.$fkey.'</CusCode>
                                <CusName>'.$cus_name.'</CusName>
                                <CusAddress>Thành phố Đà Nẵng</CusAddress>
                                <Products>
                                    <Product>
                                        <ProdName>'.$prod_name.'</ProdName>
                                        <Total>'.$total_before_vat.'</Total>
                                        <VATRate>'.$vat.'</VATRate>
                                        <VATAmount>'.$total_vat.'</VATAmount>
                                        <Amount>'.$total_price.'</Amount>
                                        <IsSum>0</IsSum>
                                    </Product>
                                </Products>
                                <Total>'.$total_before_vat.'</Total>
                                <VATRate>'.$vat.'</VATRate>
                                <VATAmount>'.$total_vat.'</VATAmount>
                                <Amount>'.$total_price.'</Amount>
                                <AmountInWords>VND</AmountInWords>
                                <Buyer>'.$cus_name.'</Buyer>
                                <Fkey>'.$fkey.'</Fkey>
                                <CurrencyUnit>VND</CurrencyUnit>
                            </Invoice>
                        </Inv>
                    </Invoices>
                ',
                'username' => 'demoservice',
                'password' => '123456aA@',
                'pattern' => $pattern,
                'serial' => strtoupper($serial),
                'convert' => 0,
            );
            $message = $soapClient->ImportAndPublishInv($param);
            $data['status'] = 200;
            $data['message'] = $message;
        } catch(Exception $ex) {
            $data['status'] = 400;
            $data['message'] = $ex->getMessage();
        }
        return $data;
    }

    public function replace($fkey, $newFkey, $cus_name, $prod_name, $vat, $total_vat, $total_before_vat, $total_price, $pattern, $serial) {
        $data = array();
        try {
            $soapClient = new SoapClient('https://ttquanlykhaithacnhadngadmindemo.vnpt-invoice.com.vn/BusinessService.asmx?wsdl');
            $param = array(
                'Account' => 'ttquanlykhaithacnhadngadmin',
                'ACpass' => 'Einv@oi@vn#pt20',
                'xmlInvData' => '
                    <ReplaceInv>
                        <key>'.$newFkey.'</key>
                        <CusCode>'.$newFkey.'</CusCode>
                        <CusName>'.$cus_name.'</CusName>
                        <CusAddress>Thành phố Đà Nẵng</CusAddress>
                        <Products>
                            <Product>
                                <ProdName>'.$prod_name.'</ProdName>
                                <Amount>'.$total_price.'</Amount>
                            </Product>
                        </Products>
                        <Total>'.$total_before_vat.'</Total>
                        <VATRate>'.$vat.'</VATRate>
                        <VATAmount>'.$total_vat.'</VATAmount>
                        <Amount>'.$total_price.'</Amount>
                        <AmountInWords>Số tiền viết bằng chữ</AmountInWords>
                        <Buyer>'.$cus_name.'</Buyer>
                        <Fkey>'.$newFkey.'</Fkey>
                    </ReplaceInv>
                ',
                'username' => 'demoservice',
                'pass' => '123456aA@',
                'pattern' => $pattern,
                'serial' => strtoupper($serial),
                'convert' => 0,
                'fkey' => $fkey,
            );
            $message = $soapClient->replaceInv($param);
            $data['status'] = 200;
            $data['message'] = $message;
        } catch(Exception $ex) {
            $data['status'] = 400;
            $data['message'] = $ex->getMessage();
        }
        return $data;
    }

    public function adjust($fkey, $newFkey, $cus_name, $prod_name, $vat, $total_vat, $total_before_vat, $total_price, $adjustType, $pattern, $serial) {
        $data = array();
        try {
            $soapClient = new SoapClient('https://ttquanlykhaithacnhadngadmindemo.vnpt-invoice.com.vn/BusinessService.asmx?wsdl');
            $param = array(
                'Account' => 'ttquanlykhaithacnhadngadmin',
                'ACpass' => 'Einv@oi@vn#pt20',
                'xmlInvData' => '
                    <AdjustInv>
                        <key>'.$newFkey.'</key>
                        <CusCode>'.$newFkey.'</CusCode>
                        <CusName>'.$cus_name.'</CusName>
                        <CusAddress>Thành phố Đà nẵng</CusAddress>
                        <Products>
                            <Product>
                                <ProdName>'.$prod_name.'</ProdName>
                                <Amount>'.$total_price.'</Amount>
                                <Total>'.$total_before_vat.'</Total>
                                <VATRate>'.$vat.'</VATRate>
                                <VATAmount>'.$total_vat.'</VATAmount>
                                <IsSum>0</IsSum>
                            </Product>
                        </Products>
                        <Total>'.$total_before_vat.'</Total>
                        <VATRate>'.$vat.'</VATRate>
                        <VATAmount>'.$total_vat.'</VATAmount>
                        <Amount>'.$total_price.'</Amount>
                        <AmountInWords>Số tiền viết bằng chữ</AmountInWords>
                        <Buyer>'.$cus_name.'</Buyer>
                        <Fkey>'.$newFkey.'</Fkey>
                        <CurrencyUnit>VND</CurrencyUnit>
                        <Type>'.$adjustType.'</Type>
                    </AdjustInv>
                ',
                'username' => 'demoservice',
                'pass' => '123456aA@',
                'pattern' => $pattern,
                'serial' => strtoupper($serial),
                'convert' => 0,
                'fkey' => $fkey,
            );
            $message = $soapClient->adjustInv($param);
            $data['status'] = 200;
            $data['message'] = $message;
        } catch(Exception $ex) {
            $data['status'] = 400;
            $data['message'] = $ex->getMessage();
        }
        return $data;
    }

    public function cancel($fkey) {
        $data = array();
        try {
            $soapClient = new SoapClient('https://ttquanlykhaithacnhadngadmindemo.vnpt-invoice.com.vn/BusinessService.asmx?wsdl');
            $param = array(
                'Account' => 'ttquanlykhaithacnhadngadmin',
                'ACpass' => 'Einv@oi@vn#pt20',
                'userName' => 'demoservice',
                'userPass' => '123456aA@',
                'fkey' => $fkey,
            );
            $message = $soapClient->cancelInv($param);
            $data['status'] = 200;
            $data['message'] = $message;
        } catch(Exception $ex) {
            $data['status'] = 400;
            $data['message'] = $ex->getMessage();
        }
        return $data;
    }
}
