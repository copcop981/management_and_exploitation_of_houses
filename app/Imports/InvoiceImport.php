<?php

namespace App\Imports;

use DateTime;
use Carbon\Carbon;
use App\Models_12345\Invoice;
use App\Models_12345\Household;
use App\Models_12345\HouseholdRoom;
use Illuminate\Support\Facades\Auth;
use Maatwebsite\Excel\Concerns\ToModel;
use Maatwebsite\Excel\Concerns\Importable;
use Maatwebsite\Excel\Concerns\WithHeadingRow;


class InvoiceImport implements ToModel, WithHeadingRow
{
    use Importable;
    /**
    * @param array $row
    *
    * @return \Illuminate\Database\Eloquent\Model|null
    */
    public function model(array $row)
    {
        $householdId = Household::where('phone_number', $row['phone_number'])->value('id');
        $householdRoom = HouseholdRoom::all()->where('id', $householdId)->first();
        $apartmentId = $householdRoom->room->floor->block->apartment->id;
        $blockId = $householdRoom->room->floor->block->id;
        $floorId = $householdRoom->room->floor->id;
        $roomId = $householdRoom->room->id;

        if(!array_filter($row)) return null;
        return new Invoice([
            'form_no' => $row['form_no'],
            'serial_no' => $row['serial_no'],
            'invoice_no' => $row['invoice_no'],
            'date_created' => $row['date_created'] === null ? Carbon::now() : new DateTime($row['date_created']),
            'fee_name' => $row['fee_name'],
            'fee_amount' => $row['fee_amount'] === null ? 0 : $row['fee_amount'],
            'creator' => Auth::check() ? Auth::user()->username : '',
            'pay_method' => $row['pay_method'],
            'bank_no' => $row['bank_no'],
            'bank_name' => $row['bank_name'],
            'apartment_id' => $apartmentId,
            'block_id' => $blockId,
            'floor_id' => $floorId,
            'room_id' => $roomId,
            'household_room_id' => $householdRoom->id,
        ]);
    }
}
